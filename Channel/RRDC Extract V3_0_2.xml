<channelGroup version="3.4.1">
  <id>9a32d616-ce47-47f4-8b44-cc566c25bd43</id>
  <name>RRDC Extract V3.0.2</name>
  <revision>8</revision>
  <lastModified>
    <time>1487320470171</time>
    <timezone>Europe/London</timezone>
  </lastModified>
  <description>10/04/2017 V3.0.2
Uplift of extract channel for result restructure
and dob/gender xpath fix
17/02/2017 V3.0.1
Minor changes following UHB review
06/01/2017 V3.0.0
Fairly major rework to make extract more complete
and more tolerant to missing data.
Now includes all sections of the RDA</description>
  <channels>
    <channel version="3.4.1">
      <id>9b52ae3f-ddc0-46dc-b0e7-87b4b7383e4b</id>
      <nextMetaDataId>3</nextMetaDataId>
      <name>IdentifyPatients3_0_1</name>
      <description>This channel identifies the patients to be extracted and for each one sends a message to ExtractPatientDetails&#xd;
V3_0_1 Change to use LocalPatientId instead of localpatientid&#xd;
V3_0_0 Change format of start and end dates and default to 1970-01-01 and TODAY&#xd;
V2.0.5 Fixed Extract Start and End Date&#xd;
V2.0.4 Added Extract Start and End Date logic&#xd;
V2.0.3 Remove quotes from table and column names in SELECT&#xd;
	Clear out spurious javascript from &quot;post-process script&quot;&#xd;
V2.0.2 Updated to load connection data from server configuration</description>
      <enabled>true</enabled>
      <lastModified>
        <time>1487320379030</time>
        <timezone>Europe/London</timezone>
      </lastModified>
      <revision>53</revision>
      <sourceConnector version="3.4.1">
        <metaDataId>0</metaDataId>
        <name>sourceConnector</name>
        <properties class="com.mirth.connect.connectors.jdbc.DatabaseReceiverProperties" version="3.4.1">
          <pluginProperties/>
          <pollConnectorProperties version="3.4.1">
            <pollingType>TIME</pollingType>
            <pollOnStart>true</pollOnStart>
            <pollingFrequency>5000</pollingFrequency>
            <pollingHour>1</pollingHour>
            <pollingMinute>0</pollingMinute>
            <cronJobs/>
            <pollConnectorPropertiesAdvanced>
              <weekly>true</weekly>
              <inactiveDays>
                <boolean>false</boolean>
                <boolean>false</boolean>
                <boolean>false</boolean>
                <boolean>false</boolean>
                <boolean>false</boolean>
                <boolean>false</boolean>
                <boolean>false</boolean>
                <boolean>false</boolean>
              </inactiveDays>
              <dayOfMonth>1</dayOfMonth>
              <allDay>true</allDay>
              <startingHour>8</startingHour>
              <startingMinute>0</startingMinute>
              <endingHour>17</endingHour>
              <endingMinute>0</endingMinute>
            </pollConnectorPropertiesAdvanced>
          </pollConnectorProperties>
          <sourceConnectorProperties version="3.4.1">
            <responseVariable>None</responseVariable>
            <respondAfterProcessing>true</respondAfterProcessing>
            <processBatch>false</processBatch>
            <firstResponse>false</firstResponse>
            <processingThreads>1</processingThreads>
            <resourceIds class="linked-hash-map">
              <entry>
                <string>Default Resource</string>
                <string>[Default Resource]</string>
              </entry>
            </resourceIds>
            <queueBufferSize>1000</queueBufferSize>
          </sourceConnectorProperties>
          <driver>net.sourceforge.jtds.jdbc.Driver</driver>
          <url></url>
          <username></username>
          <password></password>
          <select>var dbConn;
try {
	dbConn = DatabaseConnectionFactory.createDatabaseConnection(configurationMap.get(&quot;dbDriver&quot;),
	                                                            configurationMap.get(&quot;dbUrl&quot;),
								    configurationMap.get(&quot;dbUser&quot;),
								    configurationMap.get(&quot;dbPassword&quot;));
	logger.info(&quot;Created new Connection:&quot;+dbConn);
	globalMap.put(&apos;ukrdcDbConn&apos;, dbConn);
	var patient = dbConn.executeCachedQuery(&apos;SELECT LocalPatientId as pid FROM UKRDC_VIEW_COHORT&apos;);

	var d = new Date();

	// Set extract start and end
	var endDateOffset = parseInt(configurationMap.get(&quot;endDateOffset&quot;));
	logger.info(&quot;endDateOffset:&quot;+endDateOffset);
	if (isNaN(endDateOffset)) {
	  // default if no end date configured
	  var extractEndDate = new Date();
	  logger.info(&quot;End date defaulted to today:&quot;+extractEndDate);
	} else {
	  endDateOffset = endDateOffset;
	  var extractEndDate = new Date(d.getFullYear(),d.getMonth(),d.getDate()+endDateOffset);
	  logger.info(&quot;End date calculated:&quot;+extractEndDate);
	}
	
	var startDateOffset = parseInt(configurationMap.get(&quot;startDateOffset&quot;));
	logger.info(&quot;startDateOffset:&quot;+startDateOffset);
	if (isNaN(startDateOffset)) {
	  // default if no start date offset configured
	  var extractStartDate = new Date(&apos;1970-01-01&apos;);
	  logger.info(&quot;start date defaulted to today:&quot;+extractStartDate);
	  
	} else {
	  startDateOffset = startDateOffset;
	  var extractStartDate = new Date(d.getFullYear(),d.getMonth(),d.getDate()+startDateOffset);
	  logger.info(&quot;Start date calculated:&quot;+extractStartDate);
	}

	globalMap.put(&quot;ExtractStartDate&quot;, DateUtil.formatDate(&quot;yyyy-MM-dd&quot;,extractStartDate));
	globalMap.put(&quot;ExtractEndDate&quot;, DateUtil.formatDate(&quot;yyyy-MM-dd&quot;,extractEndDate));

	return patient;

} finally {
	//if (dbConn) { 
	//	dbConn.close();
	//}
}</select>
          <update></update>
          <useScript>true</useScript>
          <cacheResults>true</cacheResults>
          <keepConnectionOpen>true</keepConnectionOpen>
          <updateMode>1</updateMode>
          <retryCount>3</retryCount>
          <retryInterval>10000</retryInterval>
          <fetchSize>1000</fetchSize>
          <encoding>DEFAULT_ENCODING</encoding>
        </properties>
        <transformer version="3.4.1">
          <steps/>
          <inboundTemplate encoding="base64">PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+DQo8
cmVzdWx0Pg0KICAgIDxwaWQ+dmFsdWU8L3BpZD4NCjwvcmVzdWx0Pg0K</inboundTemplate>
          <outboundTemplate encoding="base64"></outboundTemplate>
          <inboundDataType>XML</inboundDataType>
          <outboundDataType>XML</outboundDataType>
          <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
            <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
              <stripNamespaces>true</stripNamespaces>
            </serializationProperties>
            <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
              <splitType>Element_Name</splitType>
              <elementName></elementName>
              <level>1</level>
              <query></query>
              <batchScript></batchScript>
            </batchProperties>
          </inboundProperties>
          <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
            <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
              <stripNamespaces>true</stripNamespaces>
            </serializationProperties>
            <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
              <splitType>Element_Name</splitType>
              <elementName></elementName>
              <level>1</level>
              <query></query>
              <batchScript></batchScript>
            </batchProperties>
          </outboundProperties>
        </transformer>
        <filter version="3.4.1">
          <rules/>
        </filter>
        <transportName>Database Reader</transportName>
        <mode>SOURCE</mode>
        <enabled>true</enabled>
        <waitForPrevious>true</waitForPrevious>
      </sourceConnector>
      <destinationConnectors>
        <connector version="3.4.1">
          <metaDataId>1</metaDataId>
          <name>Destination 1</name>
          <properties class="com.mirth.connect.connectors.vm.VmDispatcherProperties" version="3.4.1">
            <pluginProperties/>
            <destinationConnectorProperties version="3.4.1">
              <queueEnabled>false</queueEnabled>
              <sendFirst>false</sendFirst>
              <retryIntervalMillis>10000</retryIntervalMillis>
              <regenerateTemplate>false</regenerateTemplate>
              <retryCount>0</retryCount>
              <rotate>false</rotate>
              <includeFilterTransformer>false</includeFilterTransformer>
              <threadCount>1</threadCount>
              <threadAssignmentVariable></threadAssignmentVariable>
              <validateResponse>false</validateResponse>
              <resourceIds class="linked-hash-map">
                <entry>
                  <string>Default Resource</string>
                  <string>[Default Resource]</string>
                </entry>
              </resourceIds>
              <queueBufferSize>1000</queueBufferSize>
            </destinationConnectorProperties>
            <channelId>da25e1e0-d6cc-4a73-9559-919846f5a942</channelId>
            <channelTemplate>${message.encodedData}</channelTemplate>
            <mapVariables/>
          </properties>
          <transformer version="3.4.1">
            <steps/>
            <inboundTemplate encoding="base64">PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+DQo8
cmVzdWx0Pg0KICAgIDxwaWQ+dmFsdWU8L3BpZD4NCjwvcmVzdWx0Pg0K</inboundTemplate>
            <inboundDataType>XML</inboundDataType>
            <outboundDataType>XML</outboundDataType>
            <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </inboundProperties>
            <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </outboundProperties>
          </transformer>
          <responseTransformer version="3.4.1">
            <steps/>
            <inboundDataType>XML</inboundDataType>
            <outboundDataType>XML</outboundDataType>
            <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </inboundProperties>
            <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </outboundProperties>
          </responseTransformer>
          <filter version="3.4.1">
            <rules/>
          </filter>
          <transportName>Channel Writer</transportName>
          <mode>DESTINATION</mode>
          <enabled>true</enabled>
          <waitForPrevious>true</waitForPrevious>
        </connector>
        <connector version="3.4.1">
          <metaDataId>2</metaDataId>
          <name>Destination 2</name>
          <properties class="com.mirth.connect.connectors.vm.VmDispatcherProperties" version="3.4.1">
            <pluginProperties/>
            <destinationConnectorProperties version="3.4.1">
              <queueEnabled>false</queueEnabled>
              <sendFirst>false</sendFirst>
              <retryIntervalMillis>10000</retryIntervalMillis>
              <regenerateTemplate>false</regenerateTemplate>
              <retryCount>0</retryCount>
              <rotate>false</rotate>
              <includeFilterTransformer>false</includeFilterTransformer>
              <threadCount>1</threadCount>
              <threadAssignmentVariable></threadAssignmentVariable>
              <validateResponse>false</validateResponse>
              <resourceIds class="linked-hash-map">
                <entry>
                  <string>Default Resource</string>
                  <string>[Default Resource]</string>
                </entry>
              </resourceIds>
              <queueBufferSize>1000</queueBufferSize>
            </destinationConnectorProperties>
            <channelId>none</channelId>
            <channelTemplate>${message.encodedData}</channelTemplate>
            <mapVariables/>
          </properties>
          <transformer version="3.4.1">
            <steps/>
            <inboundTemplate encoding="base64">PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+DQo8
cmVzdWx0Pg0KICAgIDxwaWQ+dmFsdWU8L3BpZD4NCjwvcmVzdWx0Pg0K</inboundTemplate>
            <inboundDataType>XML</inboundDataType>
            <outboundDataType>XML</outboundDataType>
            <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </inboundProperties>
            <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </outboundProperties>
          </transformer>
          <responseTransformer version="3.4.1">
            <steps/>
            <inboundDataType>XML</inboundDataType>
            <outboundDataType>XML</outboundDataType>
            <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </inboundProperties>
            <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </outboundProperties>
          </responseTransformer>
          <filter version="3.4.1">
            <rules/>
          </filter>
          <transportName>Channel Writer</transportName>
          <mode>DESTINATION</mode>
          <enabled>false</enabled>
          <waitForPrevious>true</waitForPrevious>
        </connector>
      </destinationConnectors>
      <preprocessingScript>// Modify the message variable below to pre process data
return message;</preprocessingScript>
      <postprocessingScript>// This script executes once after a message has been processed
// Responses returned from here will be stored as &quot;Postprocessor&quot; in the response map
return;</postprocessingScript>
      <deployScript>// This script executes once when the channel is deployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</deployScript>
      <undeployScript>// This script executes once when the channel is undeployed
// You only have access to the globalMap and globalChannelMap here to persist data
var dbConn = globalChannelMap.get(&apos;ukrdcDbConn&apos;); 
if ( dbConn != null) dbConn.close();

return;</undeployScript>
      <properties version="3.4.1">
        <clearGlobalChannelMap>true</clearGlobalChannelMap>
        <messageStorageMode>DEVELOPMENT</messageStorageMode>
        <encryptData>false</encryptData>
        <removeContentOnCompletion>false</removeContentOnCompletion>
        <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
        <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
        <initialState>STARTED</initialState>
        <storeAttachments>false</storeAttachments>
        <tags class="linked-hash-set"/>
        <metaDataColumns>
          <metaDataColumn>
            <name>SOURCE</name>
            <type>STRING</type>
            <mappingName>mirth_source</mappingName>
          </metaDataColumn>
          <metaDataColumn>
            <name>TYPE</name>
            <type>STRING</type>
            <mappingName>mirth_type</mappingName>
          </metaDataColumn>
        </metaDataColumns>
        <attachmentProperties version="3.4.1">
          <type>None</type>
          <properties/>
        </attachmentProperties>
        <archiveEnabled>true</archiveEnabled>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
      </properties>
      <codeTemplateLibraries>
        <codeTemplateLibrary version="3.4.1">
          <id>a91916e1-43f8-42f5-bcd8-87b14d83562b</id>
          <name>RRLibrary_v3_0_1</name>
          <revision>22</revision>
          <lastModified>
            <time>1487330365794</time>
            <timezone>Europe/London</timezone>
          </lastModified>
          <description>Renal Registry Extract Library
v3_0_1 - 17-02-2017 - Use LocalPatientId instead of localpatientid
v3_0_0 - 23-01-2017 - Now fully supports RDA and naming conventions in templates
v7 - includes c: expansion
v6 - includes common fields in extract where present
v5 - includes date ranges
</description>
          <includeNewChannels>true</includeNewChannels>
          <enabledChannelIds>
            <string>0b98b374-e8e7-4be3-8b0c-1c85a0063464</string>
            <string>9b52ae3f-ddc0-46dc-b0e7-87b4b7383e4b</string>
            <string>da25e1e0-d6cc-4a73-9559-919846f5a942</string>
            <string>a4c6850d-ae1a-4af9-801f-5a9ecdbd374f</string>
            <string>6bfa2667-aa30-4c50-b994-550680dc0f78</string>
          </enabledChannelIds>
          <disabledChannelIds/>
          <codeTemplates>
            <codeTemplate version="3.4.1">
              <id>5489a394-d64d-4527-93e0-a4177713019e</id>
              <name>Add Channel Attributes</name>
              <revision>14</revision>
              <lastModified>
                <time>1482163011620</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Add the channel attributes to the message

	19/12/2016-12:28 - New Function

	@param {Any} tmp - The Mirth tmp message

*/
function addChannelAttributes(tmp){
	var currentDate = DateUtil.getCurrentDate(&apos;yyyyMMddHHmmss.SSS&apos;);
	var d = new Date();
	var endDate = globalMap.get(&quot;ExtractEndDate&quot;);
	var startDate = globalMap.get(&quot;ExtractStartDate&quot;);
     tmp.(@channelName=channelName);
     tmp.(@channelId=channelId);
     tmp.(@time=currentDate);
     tmp.(@startDate=startDate);
     tmp.(@endDate=endDate);
}</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>837910c1-b2c5-4a78-b398-72f7b438a96b</id>
              <name>Add Nodes based on table name and field array</name>
              <revision>59</revision>
              <lastModified>
                <time>1487330305076</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Add a database read for the tables, fields defined.
	Add the data returned into the node provided.
	18/01/2017-18:05 - Change the canonical form of coded fields
	11/01/2017-11:21 - Add Standard and Common Fields
     06/01/2017-12:02 - Use prepared statement
     06/01/2017-11:01 - Correct setting of node
	19/12/2016-11:48 - added tolerance for missing fields, returning &quot;N/D&quot; (Not Defined) instead of failing
				  - fixed ChannelName in error message
	25/11/2016-14:57 - remove quote from localpatientid
	22/11/2016-10:24 - add connection resilience
	21/11/2016-16:59 - xml escape the output
	15/11/2016-13:21 - get connection from globalChannelMap

	@param {Any} tmp - The Mirth tmp message
	@param {Any} pid - the patient id
	@param {Any} xmlName - name for canonical XML
	@param {Any} viewName - view name to read
	@param {Any} fields - list of field names to add to the XML
*/
function addNodes(tmp, pid, xmlName, viewName, fields){
	var dbConn;
	var result;
	var fname;
     var query = &quot;select * from &quot; +viewName + &quot; WHERE LocalPatientId = ? &quot;;
	var params = new java.util.ArrayList();
	params.add(pid);
	var sFields = [&quot;UpdatedOn&quot;, &quot;ActionCode&quot;, &quot;ExternalId&quot;];
	var cFields = [&quot;c:EnteredAt&quot;, &quot;c:EnteredBy&quot;, &quot;EnteredOn&quot;, &quot;FromTime&quot;, &quot;ToTime&quot;];

	try {
		dbConn = getCachedConnection();
		result = dbConn.executeCachedQuery(query, params);
 		while(result.next()){
 		   var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
		   for (index = 0; index &lt; fields.length; index++) {
		      var fName = fields[index];

		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, viewName+&quot;:Missing Requested Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, viewName+&quot;:Missing Requested Field&quot;);
			     node.appendChild(cfNode);
		      }
		   }
		   // Add standard fields
		   for (index = 0; index &lt; sFields.length; index++) {
		      var fName = sFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, viewName+&quot;:Missing Standard Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, viewName+&quot;:Missing Standard Field&quot;);
			     node.appendChild(cfNode);
		      }
			
		   }

		   // Add common fields
		   for (index = 0; index &lt; cFields.length; index++) {
		      var fName = cFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;&quot;, &quot;&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;&quot;, &quot;&quot;);
			     node.appendChild(cfNode);
		      }

		   }
		   tmp.appendChild(node);
		}
	} catch(e) {
		logger.error(e);
          // 2_0_4 add fault tolerance for missing views ( allows better vsn coexistance )
		var errMsg = e.javaException.getMessage();
    		logger.warn(errMsg);
 		if (errMsg.lastIndexOf(viewName,0)){
			logger.warn(channelName + &quot;: &quot; + viewName + &quot; does not exist&quot;);
			var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
			node.(@viewStatus=&quot;N/D&quot;);
	    		tmp.appendChild(node);
		} else {
			// log the error then throw to ensure that the message is flagged in error
			logger.error(query);
			logger.error(channelName + &quot; Message errored because:&quot; + e);
			throw(e);
		}

	} finally {
		//Leave the connection open
		//if (dbConn) {
		//	dbConn.close();
		//}
	}
}
</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>ecd7c75a-bc77-4471-95f0-819a04e4481c</id>
              <name>Add Nodes based on table name, field array and a date range</name>
              <revision>18</revision>
              <lastModified>
                <time>1487330308982</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Add a database read for the tables, fields defined limited by a date range
	Add the data returned into the node provided.

	12/01/2017-12:02 - Added std and common fields
     06/01/2017-11:42 - New template

	@param {Any} tmp - The Mirth tmp message
	@param {Any} pid - the patient id
	@param {Any} xmlName - name for canonical XML
	@param {Any} viewName - view name to read
	@param {Any} dateField - name of the date field used for extract selection
	@param {Any} fields - list of field names to add to the XML
*/
function addNodesByDate(tmp, pid, xmlName, viewName, dateField, fields){
	var dbConn;
	var result;
	var fname;
	var startDate = globalMap.get(&quot;ExtractStartDate&quot;); 
	var endDate = globalMap.get(&quot;ExtractEndDate&quot;); 
	var query = &quot;select * from &quot; + viewName + &quot; WHERE LocalPatientId = ? &quot; +
			  &quot; and &quot; + dateField + &quot; BETWEEN &apos;&quot; + startDate + &quot;&apos; and &apos;&quot; + endDate + &quot;&apos;&quot; ;

	var params = new java.util.ArrayList();
	params.add(pid);
	var sFields = [&quot;UpdatedOn&quot;, &quot;ActionCode&quot;, &quot;ExternalId&quot;];
	var cFields = [&quot;c:EnteredAt&quot;, &quot;c:EnteredBy&quot;, &quot;EnteredOn&quot;, &quot;FromTime&quot;, &quot;ToTime&quot;];

	try {
		dbConn = getCachedConnection();
		result = dbConn.executeCachedQuery(query, params);
 		while(result.next()){
 		   var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
		   for (index = 0; index &lt; fields.length; index++) {
		      var fName = fields[index];

		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, &quot;Missing Requested Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, &quot;Missing Requested Field&quot;);
			     node.appendChild(cfNode);
		      }
		   }
		   // Add standard fields
		   for (index = 0; index &lt; sFields.length; index++) {
		      var fName = sFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, &quot;Missing Standard Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, &quot;Missing Standard Field&quot;);
			     node.appendChild(cfNode);
		      }
			
		   }

		   // Add common fields
		   for (index = 0; index &lt; cFields.length; index++) {
		      var fName = cFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;&quot;, &quot;&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;&quot;, &quot;&quot;);
			     node.appendChild(cfNode);
		      }

		   }

		   tmp.appendChild(node);
		}
	} catch(e) {
          // 2_0_4 add fault tolerance for missing views ( allows better vsn coexistance )
		var errMsg = e.javaException.getMessage();
    		logger.warn(errMsg);
 		if (errMsg.lastIndexOf(viewName,0)){
			logger.warn(channelName + &quot;: &quot; + viewName + &quot; does not exist&quot;);
			var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
			node.(@viewStatus=&quot;N/D&quot;);
	    tmp.appendChild(node);
		} else {
			// log the error then throw to ensure that the message is flagged in error
			logger.error(query);
			logger.error(channelName + &quot; Message errored because:&quot; + e);
			throw(e);
		}

	} finally {
		//Leave the connection open
		//if (dbConn) {
		//	dbConn.close();
		//}
	}
}
</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>8888f3db-ec2a-4205-82ab-55f3108c5001</id>
              <name>Get Field</name>
              <revision>5</revision>
              <lastModified>
                <time>1484815904972</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Gets the field from the cursor, implementing appropriate error behaviour

	@param result - current cursor row
	@param fName - field name to get
	@param eLevel - what to do if it all goes wrong
	@param logMsg - what to say
	@return {String} return field value
*/
function getField(result, fName, eLevel, logMsg) {
	 var fValue = null;
      try {
	      fValue = result.getString(fName);
      } catch(fe) {
      	if (eLevel==&quot;W&quot;){
			logger.warn(channelName + logMsg + fName);
			fValue = &quot;N/D&quot;;
      	}
      }
	return fValue;
}</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>dd6b4b84-8dd9-4269-aac4-b0c3667b7e14</id>
              <name>Get the database connection</name>
              <revision>5</revision>
              <lastModified>
                <time>1479812880608</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Get a database connection. 
	Retrieve the connection from the globalMap. If that is not null and not closed then return it
	If it is not viable then get another connection.

	@return {String} return description
*/
function getCachedConnection() {
	var dbConn;
	try {
		dbConn = globalMap.get(&apos;ukrdcDbConn&apos;);
		if (dbConn == null){
			dbConn = DatabaseConnectionFactory.createDatabaseConnection(configurationMap.get(&quot;dbDriver&quot;),
												     configurationMap.get(&quot;dbUrl&quot;),
												     configurationMap.get(&quot;dbUser&quot;),
												     configurationMap.get(&quot;dbPassword&quot;));
			logger.info(&quot;Connection was null. Recreated:&quot;+dbConn);
			globalMap.put(&apos;ukrdcDbConn&apos;, dbConn);
		}
		if (dbConn.getConnection().isClosed()){
			dbConn = DatabaseConnectionFactory.createDatabaseConnection(configurationMap.get(&quot;dbDriver&quot;),
												     configurationMap.get(&quot;dbUrl&quot;),
												     configurationMap.get(&quot;dbUser&quot;),
												     configurationMap.get(&quot;dbPassword&quot;));
			logger.info(&quot;Connection was closed. Recreated:&quot;+dbConn);
			globalMap.put(&apos;ukrdcDbConn&apos;, dbConn);
		}
	} catch(e) {
		// log the error then throw to ensure that the message is flagged in error
		logger.error($(&apos;ChannelName&apos;) + &quot;Error:&quot;);
		logger.error(e);
		throw(e);
		
	} finally {
		//Leave the connection open
		//if (dbConn) {
		//	dbConn.close();
		//}
	}
	return dbConn;
}
</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>fff3061e-b29a-4b8c-ac46-0d24c9e39349</id>
              <name>GetCodedFieldName</name>
              <revision>10</revision>
              <lastModified>
                <time>1485181740048</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} fname - field name
	@return {Node} return coded field node
*/
function getCodedFieldNode(result, fName, eLevel, eMessage) {
	var base = fName.substring(2);
 	var codedNode = new XML(&quot;&lt;&quot;+base+&quot;&gt;&lt;/&quot;+base+&quot;&gt;&quot;);
 	fValue = getField(result, base+&quot;Code&quot;, eLevel, eMessage);
 	if (fValue !== null) {
	   var fValueE = XmlUtil.encode(fValue);
        codedNode.appendChild(new XML(&quot;&lt;Code&gt;&quot;+fValueE.trim()+&quot;&lt;/Code&gt;&quot;));
 	}
 	fValue = getField(result, base+&quot;CodeStd&quot;, eLevel, eMessage);
 	if (fValue !== null) {
	   var fValueE = XmlUtil.encode(fValue);
        codedNode.appendChild(new XML(&quot;&lt;CodeStd&gt;&quot;+fValueE.trim()+&quot;&lt;/CodeStd&gt;&quot;));
 	}
 	fValue = getField(result, base+&quot;Desc&quot;, eLevel, eMessage);
 	if (fValue !== null) {
	   var fValueE = XmlUtil.encode(fValue);
        codedNode.appendChild(new XML(&quot;&lt;Desc&gt;&quot;+fValueE.trim()+&quot;&lt;/Desc&gt;&quot;));
 	}
 	return codedNode;
}</code>
            </codeTemplate>
          </codeTemplates>
        </codeTemplateLibrary>
      </codeTemplateLibraries>
    </channel>
    <channel version="3.4.1">
      <id>da25e1e0-d6cc-4a73-9559-919846f5a942</id>
      <nextMetaDataId>2</nextMetaDataId>
      <name>ExtractPatientDetails3_0_2</name>
      <description>This channel accepts an XML message containing a Patient ID (pid) and builds an RDA document for that patient.&#xd;
This is achieved through a number of Source transformer steps to add in data from each of the source tables to build a simple, logical XML structure in tmp.&#xd;
Finally this is transformed (XSLT) into a RDA format and written to a file.&#xd;
3.0.2 - 10-04-2017 - Change Result structure and fix XPATH for Gender and DOB&#xd;
3.0.1 - 17-02-2017 - Minor changes following UHB review&#xd;
3.0.0 - 18-01-2017 - Significant update to fully align with RDA.&#xd;
</description>
      <enabled>true</enabled>
      <lastModified>
        <time>1491832818141</time>
        <timezone>Europe/London</timezone>
      </lastModified>
      <revision>141</revision>
      <sourceConnector version="3.4.1">
        <metaDataId>0</metaDataId>
        <name>sourceConnector</name>
        <properties class="com.mirth.connect.connectors.vm.VmReceiverProperties" version="3.4.1">
          <pluginProperties/>
          <sourceConnectorProperties version="3.4.1">
            <responseVariable>None</responseVariable>
            <respondAfterProcessing>true</respondAfterProcessing>
            <processBatch>false</processBatch>
            <firstResponse>false</firstResponse>
            <processingThreads>1</processingThreads>
            <resourceIds class="linked-hash-map">
              <entry>
                <string>Default Resource</string>
                <string>[Default Resource]</string>
              </entry>
            </resourceIds>
            <queueBufferSize>1000</queueBufferSize>
          </sourceConnectorProperties>
        </properties>
        <transformer version="3.4.1">
          <steps>
            <step>
              <sequenceNumber>0</sequenceNumber>
              <name>Setup</name>
              <script>addChannelAttributes(tmp);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>addChannelAttributes(tmp);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>1</sequenceNumber>
              <name>Add Patient Details</name>
              <script>logger.info(&apos;start basic&apos;);
var pid = msg[&apos;pid&apos;].toString();
var bfields = [&quot;SendingFacility&quot;, &quot;LocalPatientId&quot;, &quot;BirthTime&quot;, &quot;DeathTime&quot;, &quot;Gender&quot;, 
		   &quot;CountryOfBirth&quot;, &quot;EthnicGroup&quot;, &quot;Occupation&quot; , &quot;PatientLanguage&quot;, &quot;Death&quot;,
		   &quot;FamilyDoctor_GPPracticeId&quot;, &quot;FamilyDoctor_GPId&quot;,
		   &quot;PersonToContactName&quot;,&quot;PersonToContact_ContactNumber&quot;,
		   &quot;PersonToContact_ContactNumberType&quot;,&quot;PersonToContact_Relationship&quot;];
addNodes(tmp, pid, &quot;Patient&quot;, &quot;UKRDC_VIEW_PATIENT&quot;, bfields);

logger.info(&apos;start name&apos;);
var pid = msg[&apos;pid&apos;].toString();
var nfields = [&quot;NameUse&quot;, &quot;Prefix&quot;, &quot;Family&quot;, &quot;Given&quot;, &quot;Given2&quot;, &quot;Suffix&quot;];
addNodes(tmp, pid, &quot;Name&quot;, &quot;UKRDC_VIEW_NAME&quot;, nfields);

logger.info(&apos;start address&apos;);
var pid = msg[&apos;pid&apos;].toString();
var afields = [&quot;AddressUse&quot;, &quot;Street&quot;, &quot;Town&quot;,
		    &quot;County&quot;, &quot;Postcode&quot;, &quot;Country&quot;];
addNodes(tmp, pid, &quot;Address&quot;, &quot;UKRDC_VIEW_ADDRESS&quot;, afields);

logger.info(&apos;start contact&apos;);
var pid = msg[&apos;pid&apos;].toString();
var cfields = [&quot;ContactUse&quot;, &quot;ContactValue&quot;, &quot;CommentText&quot;];
addNodes(tmp, pid, &quot;ContactDetail&quot;, &quot;UKRDC_VIEW_CONTACT_DETAIL&quot;,  cfields);

logger.info(&apos;start numbers&apos;);
var pid = msg[&apos;pid&apos;].toString();
var nofields = [&quot;PatientId&quot;, &quot;Organization&quot;, &quot;NumberType&quot;];
addNodes(tmp, pid, &quot;PatientNumber&quot;, &quot;UKRDC_VIEW_PATIENT_NOS&quot;, nofields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start basic&apos;);
var pid = msg[&apos;pid&apos;].toString();
var bfields = [&quot;SendingFacility&quot;, &quot;LocalPatientId&quot;, &quot;BirthTime&quot;, &quot;DeathTime&quot;, &quot;Gender&quot;, 
		   &quot;CountryOfBirth&quot;, &quot;EthnicGroup&quot;, &quot;Occupation&quot; , &quot;PatientLanguage&quot;, &quot;Death&quot;,
		   &quot;FamilyDoctor_GPPracticeId&quot;, &quot;FamilyDoctor_GPId&quot;,
		   &quot;PersonToContactName&quot;,&quot;PersonToContact_ContactNumber&quot;,
		   &quot;PersonToContact_ContactNumberType&quot;,&quot;PersonToContact_Relationship&quot;];
addNodes(tmp, pid, &quot;Patient&quot;, &quot;UKRDC_VIEW_PATIENT&quot;, bfields);

logger.info(&apos;start name&apos;);
var pid = msg[&apos;pid&apos;].toString();
var nfields = [&quot;NameUse&quot;, &quot;Prefix&quot;, &quot;Family&quot;, &quot;Given&quot;, &quot;Given2&quot;, &quot;Suffix&quot;];
addNodes(tmp, pid, &quot;Name&quot;, &quot;UKRDC_VIEW_NAME&quot;, nfields);

logger.info(&apos;start address&apos;);
var pid = msg[&apos;pid&apos;].toString();
var afields = [&quot;AddressUse&quot;, &quot;Street&quot;, &quot;Town&quot;,
		    &quot;County&quot;, &quot;Postcode&quot;, &quot;Country&quot;];
addNodes(tmp, pid, &quot;Address&quot;, &quot;UKRDC_VIEW_ADDRESS&quot;, afields);

logger.info(&apos;start contact&apos;);
var pid = msg[&apos;pid&apos;].toString();
var cfields = [&quot;ContactUse&quot;, &quot;ContactValue&quot;, &quot;CommentText&quot;];
addNodes(tmp, pid, &quot;ContactDetail&quot;, &quot;UKRDC_VIEW_CONTACT_DETAIL&quot;,  cfields);

logger.info(&apos;start numbers&apos;);
var pid = msg[&apos;pid&apos;].toString();
var nofields = [&quot;PatientId&quot;, &quot;Organization&quot;, &quot;NumberType&quot;];
addNodes(tmp, pid, &quot;PatientNumber&quot;, &quot;UKRDC_VIEW_PATIENT_NOS&quot;, nofields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>2</sequenceNumber>
              <name>Add Orders</name>
              <script>logger.info(&apos;start orders&apos;);
var pid = msg[&apos;pid&apos;].toString();
var ofields = [&quot;PlacerId&quot;, &quot;FillerId&quot;, &quot;c:OrderedBy&quot;, &quot;c:PatientClass&quot;,
 			&quot;c:OrderCategory&quot;, &quot;SpecimenSource&quot;, 
		     &quot;SpecimenReceivedTime&quot;, &quot;SpecimenCollectedTime&quot;, &quot;Duration&quot;];
//addNodesByDate(tmp, pid, &quot;Order&quot;, &quot;UKRDC_VIEW_ORDER&quot;, &quot;UpdatedOn&quot;, ofields);
addNodes(tmp, pid, &quot;Order&quot;, &quot;UKRDC_VIEW_ORDER&quot;, ofields);

logger.info(&apos;start order items&apos;);
var pid = msg[&apos;pid&apos;].toString();
var oifields = [&quot;PlacerId&quot;, &quot;c:ServiceId&quot;];
//addNodesByDate(tmp, pid, &quot;OrderItem&quot;, &quot;UKRDC_VIEW_ORDER_ITEM&quot;, &quot;UpdatedOn&quot;, oifields);
addNodes(tmp, pid, &quot;OrderItem&quot;, &quot;UKRDC_VIEW_ORDER_ITEM&quot;, oifields);

logger.info(&apos;start result items&apos;);
var pid = msg[&apos;pid&apos;].toString();
var rfields = [&quot;PlacerId&quot;, &quot;c:ServiceId&quot;, &quot;ObservationValueType&quot;, &quot;SubId&quot;, 
		    &quot;ResultValue&quot;, &quot;ResultValueUnits&quot;, &quot;ReferenceRange&quot;, 
		    &quot;AbnormalFlags&quot;, &quot;Status&quot;, &quot;ObservationTime&quot;, 
		    &quot;CommentText&quot;, &quot;ReferenceComment&quot;, &quot;PrePost&quot;]; 
addNodes(tmp, pid, &quot;ResultItem&quot;, &quot;UKRDC_VIEW_RESULT_ITEM&quot;, rfields);
//addNodesByDate(tmp, pid, &quot;ResultItem&quot;, &quot;UKRDC_VIEW_RESULT_ITEM&quot;, &quot;UpdatedOn&quot;, rfields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start orders&apos;);
var pid = msg[&apos;pid&apos;].toString();
var ofields = [&quot;PlacerId&quot;, &quot;FillerId&quot;, &quot;c:OrderedBy&quot;, &quot;c:PatientClass&quot;,
 			&quot;c:OrderCategory&quot;, &quot;SpecimenSource&quot;, 
		     &quot;SpecimenReceivedTime&quot;, &quot;SpecimenCollectedTime&quot;, &quot;Duration&quot;];
//addNodesByDate(tmp, pid, &quot;Order&quot;, &quot;UKRDC_VIEW_ORDER&quot;, &quot;UpdatedOn&quot;, ofields);
addNodes(tmp, pid, &quot;Order&quot;, &quot;UKRDC_VIEW_ORDER&quot;, ofields);

logger.info(&apos;start order items&apos;);
var pid = msg[&apos;pid&apos;].toString();
var oifields = [&quot;PlacerId&quot;, &quot;c:ServiceId&quot;];
//addNodesByDate(tmp, pid, &quot;OrderItem&quot;, &quot;UKRDC_VIEW_ORDER_ITEM&quot;, &quot;UpdatedOn&quot;, oifields);
addNodes(tmp, pid, &quot;OrderItem&quot;, &quot;UKRDC_VIEW_ORDER_ITEM&quot;, oifields);

logger.info(&apos;start result items&apos;);
var pid = msg[&apos;pid&apos;].toString();
var rfields = [&quot;PlacerId&quot;, &quot;c:ServiceId&quot;, &quot;ObservationValueType&quot;, &quot;SubId&quot;, 
		    &quot;ResultValue&quot;, &quot;ResultValueUnits&quot;, &quot;ReferenceRange&quot;, 
		    &quot;AbnormalFlags&quot;, &quot;Status&quot;, &quot;ObservationTime&quot;, 
		    &quot;CommentText&quot;, &quot;ReferenceComment&quot;, &quot;PrePost&quot;]; 
addNodes(tmp, pid, &quot;ResultItem&quot;, &quot;UKRDC_VIEW_RESULT_ITEM&quot;, rfields);
//addNodesByDate(tmp, pid, &quot;ResultItem&quot;, &quot;UKRDC_VIEW_RESULT_ITEM&quot;, &quot;UpdatedOn&quot;, rfields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>3</sequenceNumber>
              <name>Add Social Histories</name>
              <script>logger.info(&apos;start social history&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:SocialHabit&quot;];
addNodes(tmp, pid, &quot;SocialHistory&quot;, &quot;UKRDC_VIEW_SOCIALHISTORY&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start social history&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:SocialHabit&quot;];
addNodes(tmp, pid, &quot;SocialHistory&quot;, &quot;UKRDC_VIEW_SOCIALHISTORY&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>4</sequenceNumber>
              <name>Add Family Histories</name>
              <script>logger.info(&apos;start family history&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:FamilyMember&quot;, &quot;c:Diagnosis&quot;, &quot;NoteText&quot;];
addNodes(tmp, pid, &quot;FamilyHistory&quot;, &quot;UKRDC_VIEW_FAMILYHISTORY&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start family history&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:FamilyMember&quot;, &quot;c:Diagnosis&quot;, &quot;NoteText&quot;];
addNodes(tmp, pid, &quot;FamilyHistory&quot;, &quot;UKRDC_VIEW_FAMILYHISTORY&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>5</sequenceNumber>
              <name>Add Observations</name>
              <script>logger.info(&apos;start observations&apos;);
var pid = msg[&apos;pid&apos;].toString();
var ofields = [&quot;ObservationTime&quot;, 
              &quot;c:Observation&quot;, &quot;ObservationValue&quot;,&quot;ObservationUnits&quot;,
              &quot;CommentText&quot;, &quot;c:Clinician&quot;];
addNodesByDate(tmp, pid, &quot;Observation&quot;, &quot;UKRDC_VIEW_OBSERVATION&quot;, &quot;ObservationTime&quot;, ofields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start observations&apos;);
var pid = msg[&apos;pid&apos;].toString();
var ofields = [&quot;ObservationTime&quot;, 
              &quot;c:Observation&quot;, &quot;ObservationValue&quot;,&quot;ObservationUnits&quot;,
              &quot;CommentText&quot;, &quot;c:Clinician&quot;];
addNodesByDate(tmp, pid, &quot;Observation&quot;, &quot;UKRDC_VIEW_OBSERVATION&quot;, &quot;ObservationTime&quot;, ofields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>6</sequenceNumber>
              <name>Add Allergies</name>
              <script>logger.info(&apos;start Allergies&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:Allergy&quot;, &quot;c:AllergyCategory&quot;, &quot;c:Severity&quot;, &quot;c:Clinician&quot;,
			&quot;DiscoveryTime&quot;, &quot;ConfirmedTime&quot;, &quot;CommentText&quot;, &quot;InactiveTime&quot;,
			&quot;FreeTextAllergy&quot;, &quot;QualifyingDetails&quot;];
addNodes(tmp, pid, &quot;Allergy&quot;, &quot;UKRDC_VIEW_ALLERGY&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start Allergies&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:Allergy&quot;, &quot;c:AllergyCategory&quot;, &quot;c:Severity&quot;, &quot;c:Clinician&quot;,
			&quot;DiscoveryTime&quot;, &quot;ConfirmedTime&quot;, &quot;CommentText&quot;, &quot;InactiveTime&quot;,
			&quot;FreeTextAllergy&quot;, &quot;QualifyingDetails&quot;];
addNodes(tmp, pid, &quot;Allergy&quot;, &quot;UKRDC_VIEW_ALLERGY&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>7</sequenceNumber>
              <name>Add Diagnoses</name>
              <script>logger.info(&apos;start diagnosis&apos;);
var pid = msg[&apos;pid&apos;].toString();
var dfields = [&quot;DiagnosisType&quot;, &quot;c:DiagnosingClinician&quot;, &quot;c:Diagnosis&quot;,
		    &quot;IdentificationTime&quot;, &quot;OnsetTime&quot;];
addNodes(tmp, pid, &quot;Diagnosis&quot;, &quot;UKRDC_VIEW_DIAGNOSIS&quot;, dfields);

logger.info(&apos;start cause of death&apos;);
var codfields = [&quot;DiagnosisType&quot;, &quot;c:DiagnosingClinician&quot;, &quot;c:Diagnosis&quot;];
addNodes(tmp, pid, &quot;CauseOfDeath&quot;, &quot;UKRDC_VIEW_CAUSEOFDEATH&quot;, codfields);

logger.info(&apos;start renal diagnosis&apos;);
var rdfields = dfields;
addNodes(tmp, pid, &quot;RenalDiagnosis&quot;, &quot;UKRDC_VIEW_RENALDIAGNOSIS&quot;, rdfields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start diagnosis&apos;);
var pid = msg[&apos;pid&apos;].toString();
var dfields = [&quot;DiagnosisType&quot;, &quot;c:DiagnosingClinician&quot;, &quot;c:Diagnosis&quot;,
		    &quot;IdentificationTime&quot;, &quot;OnsetTime&quot;];
addNodes(tmp, pid, &quot;Diagnosis&quot;, &quot;UKRDC_VIEW_DIAGNOSIS&quot;, dfields);

logger.info(&apos;start cause of death&apos;);
var codfields = [&quot;DiagnosisType&quot;, &quot;c:DiagnosingClinician&quot;, &quot;c:Diagnosis&quot;];
addNodes(tmp, pid, &quot;CauseOfDeath&quot;, &quot;UKRDC_VIEW_CAUSEOFDEATH&quot;, codfields);

logger.info(&apos;start renal diagnosis&apos;);
var rdfields = dfields;
addNodes(tmp, pid, &quot;RenalDiagnosis&quot;, &quot;UKRDC_VIEW_RENALDIAGNOSIS&quot;, rdfields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>8</sequenceNumber>
              <name>Add Medications</name>
              <script>logger.info(&apos;start medications&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;PrescriptionNumber&quot;, &quot;c:OrderedBy&quot;, &quot;c:Route&quot;, 
	      &quot;c:DrugProductId&quot;, &quot;DrugProductGeneric&quot;, &quot;DrugProductLabelName&quot;, 
	      &quot;c:DrugProductForm&quot;, &quot;c:DrugProductStrengthUnits&quot;,
	      &quot;Frequency&quot;, &quot;CommentText&quot;, &quot;DoseQuantity&quot;, &quot;c:DoseUoM&quot;, &quot;Indication&quot;];
addNodes(tmp, pid, &quot;Medication&quot;, &quot;UKRDC_VIEW_MEDICATION&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start medications&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;PrescriptionNumber&quot;, &quot;c:OrderedBy&quot;, &quot;c:Route&quot;, 
	      &quot;c:DrugProductId&quot;, &quot;DrugProductGeneric&quot;, &quot;DrugProductLabelName&quot;, 
	      &quot;c:DrugProductForm&quot;, &quot;c:DrugProductStrengthUnits&quot;,
	      &quot;Frequency&quot;, &quot;CommentText&quot;, &quot;DoseQuantity&quot;, &quot;c:DoseUoM&quot;, &quot;Indication&quot;];
addNodes(tmp, pid, &quot;Medication&quot;, &quot;UKRDC_VIEW_MEDICATION&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>9</sequenceNumber>
              <name>Add Procedures</name>
              <script>var pid = msg[&apos;pid&apos;].toString();

logger.info(&apos;start procedure&apos;);
var pfields = [&quot;c:ProcedureType&quot;, &quot;c:Clinician&quot;, &quot;ProcedureTime&quot;];
addNodes(tmp, pid, &quot;Procedure&quot;, &quot;UKRDC_VIEW_PROCEDURE&quot;, pfields);
  
logger.info(&apos;start dialysis session&apos;);
var dfields = pfields.concat([&quot;QHD19&quot;, &quot;QHD20&quot;, &quot;QHD21&quot;, &quot;QHD33&quot;, 
					     &quot;QHD22&quot;, &quot;QHD30&quot;, &quot;QHD31&quot;, &quot;QHD32&quot;]);
addNodesByDate(tmp, pid, &quot;DialysisSession&quot;, &quot;UKRDC_VIEW_DIALYSISSESSION&quot;, &quot;UpdatedOn&quot;, dfields);

logger.info(&apos;start transplant&apos;);
// TODO - add other attributes if confirm approach with George
var tfields = pfields.concat([&quot;TRA64&quot;, &quot;TRA65&quot;, &quot;TRA66&quot;, &quot;TRA76&quot;, 
					     &quot;TRA77&quot;, &quot;TRA78&quot;, &quot;TRA79&quot;, &quot;TRA80&quot;]);
addNodes(tmp, pid, &quot;Transplant&quot;, &quot;UKRDC_VIEW_TRANSPLANT&quot;, tfields);

logger.info(&apos;start vascular access&apos;);
var vfields = pfields.concat([&quot;ACC19&quot;, &quot;ACC20&quot;, &quot;ACC21&quot;, &quot;ACC22&quot;, &quot;ACC30&quot;, &quot;ACC40&quot;]);
addNodes(tmp, pid, &quot;VascularAccess&quot;, &quot;UKRDC_VIEW_VASCULARACCESS&quot;, vfields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>var pid = msg[&apos;pid&apos;].toString();

logger.info(&apos;start procedure&apos;);
var pfields = [&quot;c:ProcedureType&quot;, &quot;c:Clinician&quot;, &quot;ProcedureTime&quot;];
addNodes(tmp, pid, &quot;Procedure&quot;, &quot;UKRDC_VIEW_PROCEDURE&quot;, pfields);
  
logger.info(&apos;start dialysis session&apos;);
var dfields = pfields.concat([&quot;QHD19&quot;, &quot;QHD20&quot;, &quot;QHD21&quot;, &quot;QHD33&quot;, 
					     &quot;QHD22&quot;, &quot;QHD30&quot;, &quot;QHD31&quot;, &quot;QHD32&quot;]);
addNodesByDate(tmp, pid, &quot;DialysisSession&quot;, &quot;UKRDC_VIEW_DIALYSISSESSION&quot;, &quot;UpdatedOn&quot;, dfields);

logger.info(&apos;start transplant&apos;);
// TODO - add other attributes if confirm approach with George
var tfields = pfields.concat([&quot;TRA64&quot;, &quot;TRA65&quot;, &quot;TRA66&quot;, &quot;TRA76&quot;, 
					     &quot;TRA77&quot;, &quot;TRA78&quot;, &quot;TRA79&quot;, &quot;TRA80&quot;]);
addNodes(tmp, pid, &quot;Transplant&quot;, &quot;UKRDC_VIEW_TRANSPLANT&quot;, tfields);

logger.info(&apos;start vascular access&apos;);
var vfields = pfields.concat([&quot;ACC19&quot;, &quot;ACC20&quot;, &quot;ACC21&quot;, &quot;ACC22&quot;, &quot;ACC30&quot;, &quot;ACC40&quot;]);
addNodes(tmp, pid, &quot;VascularAccess&quot;, &quot;UKRDC_VIEW_VASCULARACCESS&quot;, vfields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>10</sequenceNumber>
              <name>Add Documents</name>
              <script>logger.info(&apos;start documents&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;DocumentTime&quot;, &quot;NoteText&quot;, &quot;c:DocumentType&quot;, &quot;c:Clinician&quot;, 
			&quot;DocumentName&quot;, &quot;c:Status&quot;, &quot;c:FileType&quot;, &quot;Stream&quot;, &quot;DocumentURL&quot;];
addNodes(tmp, pid, &quot;Document&quot;, &quot;UKRDC_VIEW_DOCUMENT&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start documents&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;DocumentTime&quot;, &quot;NoteText&quot;, &quot;c:DocumentType&quot;, &quot;c:Clinician&quot;, 
			&quot;DocumentName&quot;, &quot;c:Status&quot;, &quot;c:FileType&quot;, &quot;Stream&quot;, &quot;DocumentURL&quot;];
addNodes(tmp, pid, &quot;Document&quot;, &quot;UKRDC_VIEW_DOCUMENT&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>11</sequenceNumber>
              <name>Add Encounters</name>
              <script>var pid = msg[&apos;pid&apos;].toString();

logger.info(&apos;start Encounters:Encounter&apos;);
var efields = [&quot;EncounterNumber&quot;, &quot;EncounterType&quot;, &quot;c:AdmittingClinician&quot;,
			&quot;c:AdmitReason&quot;, &quot;c:HealthCareFacility&quot;, &quot;VisitDescription&quot;];
addNodes(tmp, pid, &quot;Encounter&quot;, &quot;UKRDC_VIEW_ENCOUNTER&quot;, efields);
  
logger.info(&apos;start Encounters:Treatment&apos;);
var tfields = efields.concat([&quot;c:DischargeReason&quot;, &quot;HDP01&quot;, &quot;HDP02&quot;, &quot;HDP03&quot;, &quot;HDP04&quot;,
						&quot;QBL05&quot;, &quot;QBL06&quot;, &quot;QBL07&quot;, &quot;ERF61&quot;, &quot;PAT35&quot;]);
addNodes(tmp, pid, &quot;Treatment&quot;, &quot;UKRDC_VIEW_TREATMENT&quot;, tfields);

logger.info(&apos;start Encounters:TransplantList&apos;);
var tlfields = efields.concat([&quot;c:DischargeReason&quot;]);
addNodes(tmp, pid, &quot;TransplantList&quot;, &quot;UKRDC_VIEW_TRANSPLANTLIST&quot;, tlfields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>var pid = msg[&apos;pid&apos;].toString();

logger.info(&apos;start Encounters:Encounter&apos;);
var efields = [&quot;EncounterNumber&quot;, &quot;EncounterType&quot;, &quot;c:AdmittingClinician&quot;,
			&quot;c:AdmitReason&quot;, &quot;c:HealthCareFacility&quot;, &quot;VisitDescription&quot;];
addNodes(tmp, pid, &quot;Encounter&quot;, &quot;UKRDC_VIEW_ENCOUNTER&quot;, efields);
  
logger.info(&apos;start Encounters:Treatment&apos;);
var tfields = efields.concat([&quot;c:DischargeReason&quot;, &quot;HDP01&quot;, &quot;HDP02&quot;, &quot;HDP03&quot;, &quot;HDP04&quot;,
						&quot;QBL05&quot;, &quot;QBL06&quot;, &quot;QBL07&quot;, &quot;ERF61&quot;, &quot;PAT35&quot;]);
addNodes(tmp, pid, &quot;Treatment&quot;, &quot;UKRDC_VIEW_TREATMENT&quot;, tfields);

logger.info(&apos;start Encounters:TransplantList&apos;);
var tlfields = efields.concat([&quot;c:DischargeReason&quot;]);
addNodes(tmp, pid, &quot;TransplantList&quot;, &quot;UKRDC_VIEW_TRANSPLANTLIST&quot;, tlfields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>12</sequenceNumber>
              <name>Add Program Memberships</name>
              <script>logger.info(&apos;start prog mbr&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;ProgramName&quot;, &quot;ProgramDescription&quot;];
addNodes(tmp, pid, &quot;ProgramMembership&quot;, &quot;UKRDC_VIEW_PROGRAMMEMBERSHIP&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start prog mbr&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;ProgramName&quot;, &quot;ProgramDescription&quot;];
addNodes(tmp, pid, &quot;ProgramMembership&quot;, &quot;UKRDC_VIEW_PROGRAMMEMBERSHIP&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>13</sequenceNumber>
              <name>Add Clinical Relationships</name>
              <script>logger.info(&apos;start Clinical Relationships&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:Clinician&quot;, &quot;c:Facility&quot;];
addNodes(tmp, pid, &quot;ClinicalRelationship&quot;, &quot;UKRDC_VIEW_CLINICALRELATIONSHIP&quot;, fields);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start Clinical Relationships&apos;);
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;c:Clinician&quot;, &quot;c:Facility&quot;];
addNodes(tmp, pid, &quot;ClinicalRelationship&quot;, &quot;UKRDC_VIEW_CLINICALRELATIONSHIP&quot;, fields);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>14</sequenceNumber>
              <name>Add Surveys</name>
              <script>logger.info(&apos;start surveys&apos;);
// TODO : Questions and scores are actually arrays of objects
//        Implementation deferred as may never use this channel
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;SurveyTime&quot;, &quot;c:SurveyType&quot;,  &quot;Questions&quot;, &quot;Scores&quot;];
addNodes(tmp, pid, &quot;Survey&quot;, &quot;UKRDC_VIEW_SURVEY&quot;, fields);

logger.info(&apos;start XSLT&apos;);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;start surveys&apos;);
// TODO : Questions and scores are actually arrays of objects
//        Implementation deferred as may never use this channel
var pid = msg[&apos;pid&apos;].toString();
var fields = [&quot;SurveyTime&quot;, &quot;c:SurveyType&quot;,  &quot;Questions&quot;, &quot;Scores&quot;];
addNodes(tmp, pid, &quot;Survey&quot;, &quot;UKRDC_VIEW_SURVEY&quot;, fields);

logger.info(&apos;start XSLT&apos;);</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>15</sequenceNumber>
              <name>To RDA</name>
              <script>tFactory = Packages.javax.xml.transform.TransformerFactory.newInstance();
xsltTemplate = new Packages.java.io.StringReader(&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!--
V3_0_2     - 07/04/2017 - 1] Restructure 0..8 ResultItem inside ResultItems wrapper. 2] correct dob and gender xpaths.
V3_0_0_5 - 17/02/2017 - Remove use of extensions due to unreliable behaviour
V3_0_0_4 - 19/01/2017 - Full use of CodedField and SimpleField templates making the transformation consistent in error behaviour and easier &amp; less fragile to script
V3_0_0_3 - 18/01/2017 - Adds the CodedField Template
V3_0_0_2 - 18/01/2017 - Some rationalisation with simple CommonMetadata template
V3_0_0_1 - 18/01/2017 - Align full dataset with rationalised RDA
--&gt;
&lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; 
xmlns:n1=&quot;http://www.rixg.org.uk/&quot;
xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; exclude-result-prefixes=&quot;n1 xs&quot;&gt;
	&lt;xsl:output method=&quot;xml&quot; encoding=&quot;UTF-8&quot; byte-order-mark=&quot;no&quot; indent=&quot;yes&quot;/&gt;
	&lt;xsl:template match=&quot;/&quot;&gt;
		&lt;xsl:variable name=&quot;patient&quot; select=&quot;PatientDetails/Patient&quot;/&gt;
		&lt;xsl:variable name=&quot;patientDetails&quot; select=&quot;PatientDetails&quot;/&gt;

&lt;n1:PatientRecord xmlns:n1=&quot;http://www.rixg.org.uk/&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &gt;
&lt;!--&lt;xsl:attribute name=&quot;xsi:schemaLocation&quot; namespace=&quot;xsi&quot;
select=&quot;file:///C:/Users/user/Dropbox/Renal%20Registry/Schema%20Work/NJ%20UKRDC%20v1.01.xsd&apos;&quot;/&gt;
--&gt;
&lt;xsl:attribute name=&quot;xsi:schemaLocation&quot; namespace=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; select=&quot;&apos;http://www.rixg.org.uk/ file:///C:/Users/Nick/Dropbox/Agiloak/Clients/Renal%20Registry/ukrdc/Schema/UKRDC.xsd&apos;&quot;/&gt;

&lt;!--
&lt;n1:PatientRecord xmlns:n1=&quot;http://www.rixg.org.uk/&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; 
xsi:schemaLocation=&quot;http://www.rixg.org.uk/ file:///C:/Users/user/Dropbox/Renal%20Registry/Schema%20Work/NJ%20UKRDC%20v1.01.xsd&quot;&gt;
--&gt;
			&lt;SendingFacility&gt;
				&lt;xsl:attribute name=&quot;channelName&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@channelName&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;channelId&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@channelId&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;time&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@time&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:value-of select=&quot;$patient/SendingFacility&quot; /&gt;
			&lt;/SendingFacility&gt;

			&lt;Patient&gt;
				&lt;PatientNumbers&gt;
					&lt;PatientNumber&gt;
						&lt;Number&gt;&lt;xsl:value-of select=&quot;$patient/LocalPatientId&quot; /&gt;&lt;/Number&gt;
						&lt;Organization&gt;LOCALHOSP&lt;/Organization&gt;
						&lt;!--&lt;Organization&gt;&lt;xsl:value-of select=&quot;$patient/SendingFacility&quot; /&gt;&lt;/Organization&gt;--&gt;
						&lt;NumberType&gt;MRN&lt;/NumberType&gt;
					&lt;/PatientNumber&gt;
					&lt;xsl:for-each select=&quot;$patientDetails/PatientNumber&quot;&gt;
						&lt;PatientNumber&gt;
							&lt;Number&gt;&lt;xsl:value-of select=&quot;./PatientId&quot; /&gt;&lt;/Number&gt;
							&lt;Organization&gt;&lt;xsl:value-of select=&quot;./Organization&quot; /&gt;&lt;/Organization&gt;
							&lt;NumberType&gt;&lt;xsl:value-of select=&quot;./NumberType&quot; /&gt;&lt;/NumberType&gt;
						&lt;/PatientNumber&gt;
					&lt;/xsl:for-each&gt;
				&lt;/PatientNumbers&gt;
				&lt;Names&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Name&quot;&gt;
					&lt;Name use=&quot;{./NameUse}&quot;&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Prefix&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Family&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Given&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Given2&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Given&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Suffix&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;/Name&gt;
				&lt;/xsl:for-each&gt;
				&lt;/Names&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/BirthTime&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/Gender&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;Addresses&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Address&quot;&gt;
					&lt;Address use=&quot;{./AddressUse}&quot;&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Street&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Town&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./County&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Postcode&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;!-- &lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Country&quot;/&gt;&lt;/xsl:call-template&gt; --&gt;
						&lt;Country&gt;
							&lt;CodingStandard&gt;ISO3166-1&lt;/CodingStandard&gt;
							&lt;Code&gt;&lt;xsl:value-of select=&quot;./Country&quot; /&gt;&lt;/Code&gt;
						&lt;/Country&gt;
					&lt;/Address&gt;
				&lt;/xsl:for-each&gt;
				&lt;/Addresses&gt;
				&lt;ContactDetails&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/ContactDetail&quot;&gt;
					&lt;ContactDetail use=&quot;{./ContactUse}&quot;&gt;
					&lt;!-- TODO: Defensive Coding around optional fields [General Comment] --&gt;
							&lt;Value&gt;&lt;xsl:value-of select=&quot;./ContactValue&quot; /&gt;&lt;/Value&gt;
							&lt;Comments&gt;&lt;xsl:value-of select=&quot;./CommentText&quot; /&gt;&lt;/Comments&gt;
					&lt;/ContactDetail&gt;
				&lt;/xsl:for-each&gt;
				&lt;/ContactDetails&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/CountryOfBirth&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;FamilyDoctor&gt;
					&lt;GPPracticeId&gt;&lt;xsl:value-of select=&quot;$patient/FamilyDoctor_GPPracticeId&quot; /&gt;&lt;/GPPracticeId&gt;
					&lt;GPId&gt;&lt;xsl:value-of select=&quot;$patient/FamilyDoctor_GPId&quot; /&gt;&lt;/GPId&gt;
				&lt;/FamilyDoctor&gt;
				&lt;PersonToContact&gt;
						&lt;Name&gt;&lt;xsl:value-of select=&quot;$patient/PersonToContactName&quot; /&gt;&lt;/Name&gt;
						&lt;ContactDetails use=&quot;{$patient/PersonToContact_ContactNumberType}&quot;&gt;
								&lt;Value&gt;&lt;xsl:value-of select=&quot;$patient/PersonToContact_ContactNumber&quot; /&gt;&lt;/Value&gt;
						&lt;/ContactDetails&gt;
						&lt;Relationship&gt;&lt;xsl:value-of select=&quot;$patient/PersonToContact_Relationship&quot; /&gt;&lt;/Relationship&gt;
				&lt;/PersonToContact&gt;
				&lt;EthnicGroup&gt;&lt;Code&gt;&lt;xsl:value-of select=&quot;$patient/EthnicGroup&quot; /&gt;&lt;/Code&gt;&lt;/EthnicGroup&gt;
				&lt;Occupation&gt;&lt;Code&gt;&lt;xsl:value-of select=&quot;$patient/Occupation&quot; /&gt;&lt;/Code&gt;&lt;/Occupation&gt;
				&lt;PrimaryLanguage&gt;&lt;Code&gt;&lt;xsl:value-of select=&quot;$patient/PatientLanguage&quot; /&gt;&lt;/Code&gt;&lt;/PrimaryLanguage&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/Death&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
			&lt;/Patient&gt;
			
			&lt;LabOrders&gt;
				&lt;xsl:attribute name=&quot;start&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@startDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;stop&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@endDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Order&quot;&gt;
				&lt;LabOrder&gt;
					&lt;xsl:variable name=&quot;placerId&quot; select=&quot;./PlacerId&quot;/&gt;

					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PlacerId&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FillerId&quot;/&gt;&lt;/xsl:call-template&gt;

					&lt;!-- DEFAULT Order Item for now
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OrderItem&quot;/&gt;&lt;/xsl:call-template&gt;--&gt;
					&lt;OrderItem&gt;
						&lt;CodingStandard&gt;RENAL&lt;/CodingStandard&gt;
						&lt;Code&gt;DEFAULT&lt;/Code&gt;
						&lt;Description&gt;DEFAULT&lt;/Description&gt;
					&lt;/OrderItem&gt;

					&lt;!-- DEFAULT Category for now 
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OrderCategory&quot;/&gt;&lt;/xsl:call-template&gt; --&gt;
					&lt;OrderCategory&gt;
						&lt;CodingStandard&gt;RENAL&lt;/CodingStandard&gt;
						&lt;Code&gt;DEFAULT&lt;/Code&gt;
						&lt;Description&gt;DEFAULT&lt;/Description&gt;
					&lt;/OrderCategory&gt;

					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SpecimenCollectedTime&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SpecimenReceivedTime&quot;/&gt;&lt;/xsl:call-template&gt;

					&lt;!-- Status and Priority are Defaulted in the extract. Required by HS but not available in the source
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Status&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Priority&quot;/&gt;&lt;/xsl:call-template&gt; --&gt;
				    &lt;Status&gt;E&lt;/Status&gt;
					&lt;Priority&gt;
						&lt;Code&gt;R&lt;/Code&gt;
						&lt;Description&gt;R&lt;/Description&gt;
					&lt;/Priority&gt;

					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SpecimenSource&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Duration&quot;/&gt;&lt;/xsl:call-template&gt;
					
					&lt;ResultItems&gt;
					&lt;xsl:for-each select=&quot;$patientDetails/ResultItem[PlacerId/text() = $placerId]&quot;&gt;
						&lt;ResultItem&gt;
							&lt;!-- Default in Result Type --&gt;
							&lt;ResultType&gt;AT&lt;/ResultType&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PrePost&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ServiceId&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ResultValue&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ResultValueUnits&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ReferenceRange&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AbnormalFlags&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Status&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationTime&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./CommentText&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Comments&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ReferenceComment&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/ResultItem&gt;
					&lt;/xsl:for-each&gt;
					&lt;/ResultItems&gt;

					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PatientClass&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
				&lt;/LabOrder&gt;
			&lt;/xsl:for-each&gt;
			&lt;/LabOrders&gt;

			&lt;SocialHistories&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/SocialHistory&quot;&gt;
					&lt;SocialHistory&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SocialHabit&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/SocialHistory&gt;
				&lt;/xsl:for-each&gt;
			&lt;/SocialHistories&gt;
			
			&lt;FamilyHistories&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/FamilyHistory&quot;&gt;
					&lt;FamilyHistory&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FamilyMember&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./NoteText&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/FamilyHistory&gt;
				&lt;/xsl:for-each&gt;
			&lt;/FamilyHistories&gt;
			
			&lt;Observations&gt;
				&lt;xsl:attribute name=&quot;start&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@startDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;stop&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@endDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Observation&quot;&gt;
					&lt;Observation&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationCode&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationValue&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationUnits&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Comments&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Observation&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Observations&gt;
			
			&lt;Allergies&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Allergy&quot;&gt;
					&lt;Allergy&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Allergy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AllergyCategory&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Severity&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiscoveryTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ConfirmedTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Comments&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./InactiveTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FreeTextAllergy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QualifyingDetails&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Allergy&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Allergies&gt;
			
			&lt;Diagnoses&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Diagnosis&quot;&gt;
					&lt;Diagnosis&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosisType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./IdentificationTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OnsetTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Diagnosis&gt;
				&lt;/xsl:for-each&gt;

				&lt;xsl:for-each select=&quot;$patientDetails/CauseOfDeath&quot;&gt;
					&lt;CauseOfDeath&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosisType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/CauseOfDeath&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/RenalDiagnosis&quot;&gt;
					&lt;RenalDiagnosis&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosisType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./IdentificationTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OnsetTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/RenalDiagnosis&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Diagnoses&gt;

			&lt;Medications&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Medication&quot;&gt;
					&lt;Medication&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PrescriptionNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OrderedBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Route&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;!--  TODO tidy up Drug Product - Canonical form is flatter and so std template doesnt work--&gt;
						&lt;DrugProduct&gt;
							&lt;Id&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductId/CodeStd&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;CodingStandard&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductId/Code&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Code&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductId/Desc&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Description&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;!--&lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./DrugProductIdCodeStd&quot; /&gt;&lt;/CodingStandard&gt;
								&lt;Code&gt;&lt;xsl:value-of select=&quot;./DrugProductIdCode&quot; /&gt;&lt;/Code&gt;
								&lt;Description&gt;&lt;xsl:value-of select=&quot;./DrugProductIdDesc&quot; /&gt;&lt;/Description&gt;--&gt;
							&lt;/Id&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductGeneric&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Generic&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductLabelName&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;LabelName&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;Form&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductForm/CodeStd&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;CodingStandard&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductForm/Code&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Code&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductForm/Desc&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Description&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;!--&lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./DrugProductFormStd&quot; /&gt;&lt;/CodingStandard&gt;
								&lt;Code&gt;&lt;xsl:value-of select=&quot;./DrugProductForm&quot; /&gt;&lt;/Code&gt;
								&lt;Description&gt;&lt;xsl:value-of select=&quot;./DrugProductIFormDesc&quot; /&gt;&lt;/Description&gt;--&gt;
							&lt;/Form&gt;
							&lt;StrengthUnits&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductStrengthUnits/CodeStd&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;CodingStandard&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductStrengthUnits/Code&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Code&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductStrengthUnits/Desc&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Description&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;!-- &lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./DrugProductStrengthUnitsCodeStd&quot; /&gt;&lt;/CodingStandard&gt;
								&lt;Code&gt;&lt;xsl:value-of select=&quot;./DrugProductStrengthUnitsCode&quot; /&gt;&lt;/Code&gt;
								&lt;Description&gt;&lt;xsl:value-of select=&quot;./DrugProductStrengthUnitsDesc&quot; /&gt;&lt;/Description&gt; --&gt;
							&lt;/StrengthUnits&gt;
						&lt;/DrugProduct&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Frequency&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Comments&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DoseQuantity&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DoseUoM&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Indication&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Medication&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Medications&gt;
			
			&lt;Procedures&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Procedure&quot;&gt;
					&lt;Procedure&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Procedure&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/DialysisSession&quot;&gt;
					&lt;DialysisSession&gt;
						&lt;xsl:attribute name=&quot;start&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@startDate&quot; /&gt;&lt;/xsl:attribute&gt;
						&lt;xsl:attribute name=&quot;stop&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@endDate&quot; /&gt;&lt;/xsl:attribute&gt;

						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD19&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD20&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD21&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD22&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD30&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD31&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD32&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD33&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
					&lt;/DialysisSession&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/Transplant&quot;&gt;
					&lt;Transplant&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA64&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA65&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA66&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA69&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA76&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA77&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA78&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA79&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA80&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA8A&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA81&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA82&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA83&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA84&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA85&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA86&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA87&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA88&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA89&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA90&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA91&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA92&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA93&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA94&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA95&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA96&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA97&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA98&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
					&lt;/Transplant&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/VascularAccess&quot;&gt;
					&lt;VascularAccess&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC19&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC20&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC21&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC22&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC30&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC40&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
					&lt;/VascularAccess&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Procedures&gt;
			
			&lt;Documents&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Document&quot;&gt;
					&lt;Document&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./NoteText&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentName&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Status&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FileType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Stream&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentURL&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Document&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Documents&gt;
			
			&lt;Encounters&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Encounter&quot;&gt;
					&lt;Encounter&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmittingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HealthCareFacility&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmitReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmissionSource&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeLocation&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./VisitDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Encounter&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/Treatment&quot;&gt;
					&lt;Treatment&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmittingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HealthCareFacility&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmitReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmissionSource&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeLocation&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./VisitDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP01&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP02&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP03&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP04&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QBL05&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QBL06&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QBL07&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ERF61&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PAT35&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Treatment&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/TransplantList&quot;&gt;
					&lt;TransplantList&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmittingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HealthCareFacility&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmitReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmissionSource&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeLocation&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./VisitDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/TransplantList&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Encounters&gt;
			
			&lt;ProgramMemberships&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/ProgramMembership&quot;&gt;
					&lt;ProgramMembership&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProgramName&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProgramDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/ProgramMembership&gt;
				&lt;/xsl:for-each&gt;
			&lt;/ProgramMemberships&gt;
			
			&lt;ClinicalRelationships&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/ClinicalRelationship&quot;&gt;
					&lt;ClinicalRelationship&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FacilityCode&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/ClinicalRelationship&gt;
				&lt;/xsl:for-each&gt;
			&lt;/ClinicalRelationships&gt;

			&lt;Surveys&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Survey&quot;&gt;
					&lt;Survey&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SurveyTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SurveyType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;Questions&gt;&lt;/Questions&gt;
						&lt;Scores&gt;&lt;/Scores&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Survey&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Surveys&gt;
		&lt;/n1:PatientRecord&gt;
	&lt;/xsl:template&gt;

	&lt;xsl:template name=&quot;CommonMetadata&quot;&gt;
		&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./UpdatedOn&quot;/&gt;&lt;/xsl:call-template&gt;
		&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ActionCode&quot;/&gt;&lt;/xsl:call-template&gt;
		&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ExternalId&quot;/&gt;&lt;/xsl:call-template&gt;
	&lt;/xsl:template&gt;
	
	&lt;xsl:template match=&quot;*&quot; mode=&quot;CodedField&quot;&gt;
			&lt;xsl:copy&gt;
				&lt;xsl:if test=&quot;./CodeStd&quot;&gt;
					&lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./CodeStd&quot; /&gt;&lt;/CodingStandard&gt;
				&lt;/xsl:if&gt;
				&lt;xsl:if test=&quot;./Code&quot;&gt;
					&lt;Code&gt;&lt;xsl:value-of select=&quot;./Code&quot; /&gt;&lt;/Code&gt;
				&lt;/xsl:if&gt;
				&lt;xsl:if test=&quot;./Desc&quot;&gt;
					&lt;Description&gt;&lt;xsl:value-of select=&quot;./Desc&quot; /&gt;&lt;/Description&gt;
				&lt;/xsl:if&gt;
			&lt;/xsl:copy&gt;
	&lt;/xsl:template&gt;
	
	&lt;xsl:template name=&quot;CodedField&quot;&gt;
		&lt;xsl:param name=&quot;fld&quot;/&gt;
		&lt;xsl:apply-templates mode=&quot;CodedField&quot; select=&quot;$fld&quot;/&gt;
	&lt;/xsl:template&gt;

	&lt;xsl:template name=&quot;SimpleField&quot;&gt;
		&lt;xsl:param name=&quot;fld&quot;/&gt;
		&lt;xsl:param name=&quot;fname&quot;/&gt;
		&lt;xsl:choose&gt;
			&lt;xsl:when test=&quot;$fname&quot;&gt;
				&lt;xsl:if test=&quot;$fld&quot;&gt;
					&lt;xsl:element name=&quot;{$fname}&quot;&gt;
						&lt;xsl:value-of select=&quot;$fld&quot; /&gt;
					&lt;/xsl:element&gt;
				&lt;/xsl:if&gt;
			&lt;/xsl:when&gt;
			&lt;xsl:otherwise&gt;
			    &lt;xsl:copy-of select=&quot;$fld&quot; /&gt;
			&lt;/xsl:otherwise&gt;
		&lt;/xsl:choose&gt;
	&lt;/xsl:template&gt;
	
&lt;/xsl:stylesheet&gt;);
transformer = tFactory.newTransformer(new Packages.javax.xml.transform.stream.StreamSource(xsltTemplate));
sourceVar = new Packages.java.io.StringReader(tmp);
resultVar = new Packages.java.io.StringWriter();
transformer.transform(new Packages.javax.xml.transform.stream.StreamSource(sourceVar), new Packages.javax.xml.transform.stream.StreamResult(resultVar));
channelMap.put(&apos;RDA_XML&apos;, resultVar.toString());
</script>
              <type>XSLT Step</type>
              <data>
                <entry>
                  <string>Source</string>
                  <string>tmp</string>
                </entry>
                <entry>
                  <string>Result</string>
                  <string>RDA_XML</string>
                </entry>
                <entry>
                  <string>XsltTemplate</string>
                  <string>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!--
V3_0_2     - 07/04/2017 - 1] Restructure 0..8 ResultItem inside ResultItems wrapper. 2] correct dob and gender xpaths.
V3_0_0_5 - 17/02/2017 - Remove use of extensions due to unreliable behaviour
V3_0_0_4 - 19/01/2017 - Full use of CodedField and SimpleField templates making the transformation consistent in error behaviour and easier &amp; less fragile to script
V3_0_0_3 - 18/01/2017 - Adds the CodedField Template
V3_0_0_2 - 18/01/2017 - Some rationalisation with simple CommonMetadata template
V3_0_0_1 - 18/01/2017 - Align full dataset with rationalised RDA
--&gt;
&lt;xsl:stylesheet version=&quot;2.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; 
xmlns:n1=&quot;http://www.rixg.org.uk/&quot;
xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; exclude-result-prefixes=&quot;n1 xs&quot;&gt;
	&lt;xsl:output method=&quot;xml&quot; encoding=&quot;UTF-8&quot; byte-order-mark=&quot;no&quot; indent=&quot;yes&quot;/&gt;
	&lt;xsl:template match=&quot;/&quot;&gt;
		&lt;xsl:variable name=&quot;patient&quot; select=&quot;PatientDetails/Patient&quot;/&gt;
		&lt;xsl:variable name=&quot;patientDetails&quot; select=&quot;PatientDetails&quot;/&gt;

&lt;n1:PatientRecord xmlns:n1=&quot;http://www.rixg.org.uk/&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; &gt;
&lt;!--&lt;xsl:attribute name=&quot;xsi:schemaLocation&quot; namespace=&quot;xsi&quot;
select=&quot;file:///C:/Users/user/Dropbox/Renal%20Registry/Schema%20Work/NJ%20UKRDC%20v1.01.xsd&apos;&quot;/&gt;
--&gt;
&lt;xsl:attribute name=&quot;xsi:schemaLocation&quot; namespace=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; select=&quot;&apos;http://www.rixg.org.uk/ file:///C:/Users/Nick/Dropbox/Agiloak/Clients/Renal%20Registry/ukrdc/Schema/UKRDC.xsd&apos;&quot;/&gt;

&lt;!--
&lt;n1:PatientRecord xmlns:n1=&quot;http://www.rixg.org.uk/&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; 
xsi:schemaLocation=&quot;http://www.rixg.org.uk/ file:///C:/Users/user/Dropbox/Renal%20Registry/Schema%20Work/NJ%20UKRDC%20v1.01.xsd&quot;&gt;
--&gt;
			&lt;SendingFacility&gt;
				&lt;xsl:attribute name=&quot;channelName&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@channelName&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;channelId&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@channelId&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;time&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@time&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:value-of select=&quot;$patient/SendingFacility&quot; /&gt;
			&lt;/SendingFacility&gt;

			&lt;Patient&gt;
				&lt;PatientNumbers&gt;
					&lt;PatientNumber&gt;
						&lt;Number&gt;&lt;xsl:value-of select=&quot;$patient/LocalPatientId&quot; /&gt;&lt;/Number&gt;
						&lt;Organization&gt;LOCALHOSP&lt;/Organization&gt;
						&lt;!--&lt;Organization&gt;&lt;xsl:value-of select=&quot;$patient/SendingFacility&quot; /&gt;&lt;/Organization&gt;--&gt;
						&lt;NumberType&gt;MRN&lt;/NumberType&gt;
					&lt;/PatientNumber&gt;
					&lt;xsl:for-each select=&quot;$patientDetails/PatientNumber&quot;&gt;
						&lt;PatientNumber&gt;
							&lt;Number&gt;&lt;xsl:value-of select=&quot;./PatientId&quot; /&gt;&lt;/Number&gt;
							&lt;Organization&gt;&lt;xsl:value-of select=&quot;./Organization&quot; /&gt;&lt;/Organization&gt;
							&lt;NumberType&gt;&lt;xsl:value-of select=&quot;./NumberType&quot; /&gt;&lt;/NumberType&gt;
						&lt;/PatientNumber&gt;
					&lt;/xsl:for-each&gt;
				&lt;/PatientNumbers&gt;
				&lt;Names&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Name&quot;&gt;
					&lt;Name use=&quot;{./NameUse}&quot;&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Prefix&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Family&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Given&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Given2&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Given&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Suffix&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;/Name&gt;
				&lt;/xsl:for-each&gt;
				&lt;/Names&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/BirthTime&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/Gender&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;Addresses&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Address&quot;&gt;
					&lt;Address use=&quot;{./AddressUse}&quot;&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Street&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Town&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./County&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Postcode&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;!-- &lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Country&quot;/&gt;&lt;/xsl:call-template&gt; --&gt;
						&lt;Country&gt;
							&lt;CodingStandard&gt;ISO3166-1&lt;/CodingStandard&gt;
							&lt;Code&gt;&lt;xsl:value-of select=&quot;./Country&quot; /&gt;&lt;/Code&gt;
						&lt;/Country&gt;
					&lt;/Address&gt;
				&lt;/xsl:for-each&gt;
				&lt;/Addresses&gt;
				&lt;ContactDetails&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/ContactDetail&quot;&gt;
					&lt;ContactDetail use=&quot;{./ContactUse}&quot;&gt;
					&lt;!-- TODO: Defensive Coding around optional fields [General Comment] --&gt;
							&lt;Value&gt;&lt;xsl:value-of select=&quot;./ContactValue&quot; /&gt;&lt;/Value&gt;
							&lt;Comments&gt;&lt;xsl:value-of select=&quot;./CommentText&quot; /&gt;&lt;/Comments&gt;
					&lt;/ContactDetail&gt;
				&lt;/xsl:for-each&gt;
				&lt;/ContactDetails&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/CountryOfBirth&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;FamilyDoctor&gt;
					&lt;GPPracticeId&gt;&lt;xsl:value-of select=&quot;$patient/FamilyDoctor_GPPracticeId&quot; /&gt;&lt;/GPPracticeId&gt;
					&lt;GPId&gt;&lt;xsl:value-of select=&quot;$patient/FamilyDoctor_GPId&quot; /&gt;&lt;/GPId&gt;
				&lt;/FamilyDoctor&gt;
				&lt;PersonToContact&gt;
						&lt;Name&gt;&lt;xsl:value-of select=&quot;$patient/PersonToContactName&quot; /&gt;&lt;/Name&gt;
						&lt;ContactDetails use=&quot;{$patient/PersonToContact_ContactNumberType}&quot;&gt;
								&lt;Value&gt;&lt;xsl:value-of select=&quot;$patient/PersonToContact_ContactNumber&quot; /&gt;&lt;/Value&gt;
						&lt;/ContactDetails&gt;
						&lt;Relationship&gt;&lt;xsl:value-of select=&quot;$patient/PersonToContact_Relationship&quot; /&gt;&lt;/Relationship&gt;
				&lt;/PersonToContact&gt;
				&lt;EthnicGroup&gt;&lt;Code&gt;&lt;xsl:value-of select=&quot;$patient/EthnicGroup&quot; /&gt;&lt;/Code&gt;&lt;/EthnicGroup&gt;
				&lt;Occupation&gt;&lt;Code&gt;&lt;xsl:value-of select=&quot;$patient/Occupation&quot; /&gt;&lt;/Code&gt;&lt;/Occupation&gt;
				&lt;PrimaryLanguage&gt;&lt;Code&gt;&lt;xsl:value-of select=&quot;$patient/PatientLanguage&quot; /&gt;&lt;/Code&gt;&lt;/PrimaryLanguage&gt;
				&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;$patient/Death&quot;/&gt;&lt;/xsl:call-template&gt;
				&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
			&lt;/Patient&gt;
			
			&lt;LabOrders&gt;
				&lt;xsl:attribute name=&quot;start&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@startDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;stop&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@endDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Order&quot;&gt;
				&lt;LabOrder&gt;
					&lt;xsl:variable name=&quot;placerId&quot; select=&quot;./PlacerId&quot;/&gt;

					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PlacerId&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FillerId&quot;/&gt;&lt;/xsl:call-template&gt;

					&lt;!-- DEFAULT Order Item for now
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OrderItem&quot;/&gt;&lt;/xsl:call-template&gt;--&gt;
					&lt;OrderItem&gt;
						&lt;CodingStandard&gt;RENAL&lt;/CodingStandard&gt;
						&lt;Code&gt;DEFAULT&lt;/Code&gt;
						&lt;Description&gt;DEFAULT&lt;/Description&gt;
					&lt;/OrderItem&gt;

					&lt;!-- DEFAULT Category for now 
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OrderCategory&quot;/&gt;&lt;/xsl:call-template&gt; --&gt;
					&lt;OrderCategory&gt;
						&lt;CodingStandard&gt;RENAL&lt;/CodingStandard&gt;
						&lt;Code&gt;DEFAULT&lt;/Code&gt;
						&lt;Description&gt;DEFAULT&lt;/Description&gt;
					&lt;/OrderCategory&gt;

					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SpecimenCollectedTime&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SpecimenReceivedTime&quot;/&gt;&lt;/xsl:call-template&gt;

					&lt;!-- Status and Priority are Defaulted in the extract. Required by HS but not available in the source
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Status&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Priority&quot;/&gt;&lt;/xsl:call-template&gt; --&gt;
				    &lt;Status&gt;E&lt;/Status&gt;
					&lt;Priority&gt;
						&lt;Code&gt;R&lt;/Code&gt;
						&lt;Description&gt;R&lt;/Description&gt;
					&lt;/Priority&gt;

					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SpecimenSource&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Duration&quot;/&gt;&lt;/xsl:call-template&gt;
					
					&lt;ResultItems&gt;
					&lt;xsl:for-each select=&quot;$patientDetails/ResultItem[PlacerId/text() = $placerId]&quot;&gt;
						&lt;ResultItem&gt;
							&lt;!-- Default in Result Type --&gt;
							&lt;ResultType&gt;AT&lt;/ResultType&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PrePost&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ServiceId&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ResultValue&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ResultValueUnits&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ReferenceRange&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AbnormalFlags&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Status&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationTime&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./CommentText&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Comments&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ReferenceComment&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/ResultItem&gt;
					&lt;/xsl:for-each&gt;
					&lt;/ResultItems&gt;

					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PatientClass&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
					&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
				&lt;/LabOrder&gt;
			&lt;/xsl:for-each&gt;
			&lt;/LabOrders&gt;

			&lt;SocialHistories&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/SocialHistory&quot;&gt;
					&lt;SocialHistory&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SocialHabit&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/SocialHistory&gt;
				&lt;/xsl:for-each&gt;
			&lt;/SocialHistories&gt;
			
			&lt;FamilyHistories&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/FamilyHistory&quot;&gt;
					&lt;FamilyHistory&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FamilyMember&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./NoteText&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/FamilyHistory&gt;
				&lt;/xsl:for-each&gt;
			&lt;/FamilyHistories&gt;
			
			&lt;Observations&gt;
				&lt;xsl:attribute name=&quot;start&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@startDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:attribute name=&quot;stop&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@endDate&quot; /&gt;&lt;/xsl:attribute&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Observation&quot;&gt;
					&lt;Observation&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationCode&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationValue&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ObservationUnits&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Comments&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Observation&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Observations&gt;
			
			&lt;Allergies&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Allergy&quot;&gt;
					&lt;Allergy&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Allergy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AllergyCategory&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Severity&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiscoveryTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ConfirmedTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Comments&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./InactiveTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FreeTextAllergy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QualifyingDetails&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Allergy&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Allergies&gt;
			
			&lt;Diagnoses&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Diagnosis&quot;&gt;
					&lt;Diagnosis&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosisType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./IdentificationTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OnsetTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Diagnosis&gt;
				&lt;/xsl:for-each&gt;

				&lt;xsl:for-each select=&quot;$patientDetails/CauseOfDeath&quot;&gt;
					&lt;CauseOfDeath&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosisType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/CauseOfDeath&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/RenalDiagnosis&quot;&gt;
					&lt;RenalDiagnosis&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosisType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DiagnosingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Diagnosis&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./IdentificationTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OnsetTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredOn&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/RenalDiagnosis&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Diagnoses&gt;

			&lt;Medications&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Medication&quot;&gt;
					&lt;Medication&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PrescriptionNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./OrderedBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Route&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;!--  TODO tidy up Drug Product - Canonical form is flatter and so std template doesnt work--&gt;
						&lt;DrugProduct&gt;
							&lt;Id&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductId/CodeStd&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;CodingStandard&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductId/Code&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Code&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductId/Desc&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Description&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;!--&lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./DrugProductIdCodeStd&quot; /&gt;&lt;/CodingStandard&gt;
								&lt;Code&gt;&lt;xsl:value-of select=&quot;./DrugProductIdCode&quot; /&gt;&lt;/Code&gt;
								&lt;Description&gt;&lt;xsl:value-of select=&quot;./DrugProductIdDesc&quot; /&gt;&lt;/Description&gt;--&gt;
							&lt;/Id&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductGeneric&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Generic&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductLabelName&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;LabelName&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;Form&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductForm/CodeStd&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;CodingStandard&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductForm/Code&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Code&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductForm/Desc&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Description&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;!--&lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./DrugProductFormStd&quot; /&gt;&lt;/CodingStandard&gt;
								&lt;Code&gt;&lt;xsl:value-of select=&quot;./DrugProductForm&quot; /&gt;&lt;/Code&gt;
								&lt;Description&gt;&lt;xsl:value-of select=&quot;./DrugProductIFormDesc&quot; /&gt;&lt;/Description&gt;--&gt;
							&lt;/Form&gt;
							&lt;StrengthUnits&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductStrengthUnits/CodeStd&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;CodingStandard&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductStrengthUnits/Code&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Code&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DrugProductStrengthUnits/Desc&quot;/&gt;&lt;xsl:with-param name=&quot;fname&quot; select=&quot;&apos;Description&apos;&quot;/&gt;&lt;/xsl:call-template&gt;
								&lt;!-- &lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./DrugProductStrengthUnitsCodeStd&quot; /&gt;&lt;/CodingStandard&gt;
								&lt;Code&gt;&lt;xsl:value-of select=&quot;./DrugProductStrengthUnitsCode&quot; /&gt;&lt;/Code&gt;
								&lt;Description&gt;&lt;xsl:value-of select=&quot;./DrugProductStrengthUnitsDesc&quot; /&gt;&lt;/Description&gt; --&gt;
							&lt;/StrengthUnits&gt;
						&lt;/DrugProduct&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Frequency&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Comments&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DoseQuantity&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DoseUoM&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Indication&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Medication&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Medications&gt;
			
			&lt;Procedures&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Procedure&quot;&gt;
					&lt;Procedure&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Procedure&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/DialysisSession&quot;&gt;
					&lt;DialysisSession&gt;
						&lt;xsl:attribute name=&quot;start&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@startDate&quot; /&gt;&lt;/xsl:attribute&gt;
						&lt;xsl:attribute name=&quot;stop&quot;&gt;&lt;xsl:value-of select=&quot;$patientDetails/@endDate&quot; /&gt;&lt;/xsl:attribute&gt;

						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD19&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD20&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD21&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD22&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD30&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD31&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD32&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QHD33&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
					&lt;/DialysisSession&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/Transplant&quot;&gt;
					&lt;Transplant&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA64&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA65&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA66&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA69&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA76&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA77&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA78&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA79&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA80&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA8A&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA81&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA82&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA83&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA84&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA85&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA86&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA87&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA88&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA89&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA90&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA91&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA92&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA93&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA94&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA95&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA96&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA97&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./TRA98&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
					&lt;/Transplant&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/VascularAccess&quot;&gt;
					&lt;VascularAccess&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProcedureTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC19&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC20&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC21&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC22&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC30&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ACC40&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
					&lt;/VascularAccess&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Procedures&gt;
			
			&lt;Documents&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Document&quot;&gt;
					&lt;Document&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./NoteText&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentName&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Status&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FileType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Stream&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DocumentURL&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Document&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Documents&gt;
			
			&lt;Encounters&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Encounter&quot;&gt;
					&lt;Encounter&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmittingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HealthCareFacility&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmitReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmissionSource&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeLocation&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./VisitDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Encounter&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/Treatment&quot;&gt;
					&lt;Treatment&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmittingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HealthCareFacility&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmitReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmissionSource&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeLocation&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./VisitDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;Attributes&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP01&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP02&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP03&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HDP04&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QBL05&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QBL06&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./QBL07&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ERF61&quot;/&gt;&lt;/xsl:call-template&gt;
							&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./PAT35&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;/Attributes&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Treatment&gt;
				&lt;/xsl:for-each&gt;
				
				&lt;xsl:for-each select=&quot;$patientDetails/TransplantList&quot;&gt;
					&lt;TransplantList&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterNumber&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EncounterType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmittingClinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./HealthCareFacility&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmitReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./AdmissionSource&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeReason&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./DischargeLocation&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./VisitDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/TransplantList&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Encounters&gt;
			
			&lt;ProgramMemberships&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/ProgramMembership&quot;&gt;
					&lt;ProgramMembership&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProgramName&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ProgramDescription&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/ProgramMembership&gt;
				&lt;/xsl:for-each&gt;
			&lt;/ProgramMemberships&gt;
			
			&lt;ClinicalRelationships&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/ClinicalRelationship&quot;&gt;
					&lt;ClinicalRelationship&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FromTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ToTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./Clinician&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./FacilityCode&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/ClinicalRelationship&gt;
				&lt;/xsl:for-each&gt;
			&lt;/ClinicalRelationships&gt;

			&lt;Surveys&gt;
				&lt;xsl:for-each select=&quot;$patientDetails/Survey&quot;&gt;
					&lt;Survey&gt;
						&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SurveyTime&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./SurveyType&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;Questions&gt;&lt;/Questions&gt;
						&lt;Scores&gt;&lt;/Scores&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredBy&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CodedField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./EnteredAt&quot;/&gt;&lt;/xsl:call-template&gt;
						&lt;xsl:call-template name=&quot;CommonMetadata&quot; /&gt;
					&lt;/Survey&gt;
				&lt;/xsl:for-each&gt;
			&lt;/Surveys&gt;
		&lt;/n1:PatientRecord&gt;
	&lt;/xsl:template&gt;

	&lt;xsl:template name=&quot;CommonMetadata&quot;&gt;
		&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./UpdatedOn&quot;/&gt;&lt;/xsl:call-template&gt;
		&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ActionCode&quot;/&gt;&lt;/xsl:call-template&gt;
		&lt;xsl:call-template name=&quot;SimpleField&quot; &gt;&lt;xsl:with-param name=&quot;fld&quot; select=&quot;./ExternalId&quot;/&gt;&lt;/xsl:call-template&gt;
	&lt;/xsl:template&gt;
	
	&lt;xsl:template match=&quot;*&quot; mode=&quot;CodedField&quot;&gt;
			&lt;xsl:copy&gt;
				&lt;xsl:if test=&quot;./CodeStd&quot;&gt;
					&lt;CodingStandard&gt;&lt;xsl:value-of select=&quot;./CodeStd&quot; /&gt;&lt;/CodingStandard&gt;
				&lt;/xsl:if&gt;
				&lt;xsl:if test=&quot;./Code&quot;&gt;
					&lt;Code&gt;&lt;xsl:value-of select=&quot;./Code&quot; /&gt;&lt;/Code&gt;
				&lt;/xsl:if&gt;
				&lt;xsl:if test=&quot;./Desc&quot;&gt;
					&lt;Description&gt;&lt;xsl:value-of select=&quot;./Desc&quot; /&gt;&lt;/Description&gt;
				&lt;/xsl:if&gt;
			&lt;/xsl:copy&gt;
	&lt;/xsl:template&gt;
	
	&lt;xsl:template name=&quot;CodedField&quot;&gt;
		&lt;xsl:param name=&quot;fld&quot;/&gt;
		&lt;xsl:apply-templates mode=&quot;CodedField&quot; select=&quot;$fld&quot;/&gt;
	&lt;/xsl:template&gt;

	&lt;xsl:template name=&quot;SimpleField&quot;&gt;
		&lt;xsl:param name=&quot;fld&quot;/&gt;
		&lt;xsl:param name=&quot;fname&quot;/&gt;
		&lt;xsl:choose&gt;
			&lt;xsl:when test=&quot;$fname&quot;&gt;
				&lt;xsl:if test=&quot;$fld&quot;&gt;
					&lt;xsl:element name=&quot;{$fname}&quot;&gt;
						&lt;xsl:value-of select=&quot;$fld&quot; /&gt;
					&lt;/xsl:element&gt;
				&lt;/xsl:if&gt;
			&lt;/xsl:when&gt;
			&lt;xsl:otherwise&gt;
			    &lt;xsl:copy-of select=&quot;$fld&quot; /&gt;
			&lt;/xsl:otherwise&gt;
		&lt;/xsl:choose&gt;
	&lt;/xsl:template&gt;
	
&lt;/xsl:stylesheet&gt;</string>
                </entry>
              </data>
            </step>
            <step>
              <sequenceNumber>16</sequenceNumber>
              <name>Finish</name>
              <script>logger.info(&apos;end XSLT&apos;);</script>
              <type>JavaScript</type>
              <data>
                <entry>
                  <string>Script</string>
                  <string>logger.info(&apos;end XSLT&apos;);</string>
                </entry>
              </data>
            </step>
          </steps>
          <inboundTemplate encoding="base64"></inboundTemplate>
          <outboundTemplate encoding="base64">PFBhdGllbnREZXRhaWxzPg0KPC9QYXRpZW50RGV0YWlscz4N</outboundTemplate>
          <inboundDataType>XML</inboundDataType>
          <outboundDataType>XML</outboundDataType>
          <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
            <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
              <stripNamespaces>true</stripNamespaces>
            </serializationProperties>
            <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
              <splitType>Element_Name</splitType>
              <elementName></elementName>
              <level>1</level>
              <query></query>
              <batchScript></batchScript>
            </batchProperties>
          </inboundProperties>
          <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
            <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
              <stripNamespaces>true</stripNamespaces>
            </serializationProperties>
            <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
              <splitType>Element_Name</splitType>
              <elementName></elementName>
              <level>1</level>
              <query></query>
              <batchScript></batchScript>
            </batchProperties>
          </outboundProperties>
        </transformer>
        <filter version="3.4.1">
          <rules/>
        </filter>
        <transportName>Channel Reader</transportName>
        <mode>SOURCE</mode>
        <enabled>true</enabled>
        <waitForPrevious>true</waitForPrevious>
      </sourceConnector>
      <destinationConnectors>
        <connector version="3.4.1">
          <metaDataId>1</metaDataId>
          <name>Destination 1</name>
          <properties class="com.mirth.connect.connectors.file.FileDispatcherProperties" version="3.4.1">
            <pluginProperties/>
            <destinationConnectorProperties version="3.4.1">
              <queueEnabled>false</queueEnabled>
              <sendFirst>false</sendFirst>
              <retryIntervalMillis>10000</retryIntervalMillis>
              <regenerateTemplate>false</regenerateTemplate>
              <retryCount>0</retryCount>
              <rotate>false</rotate>
              <includeFilterTransformer>false</includeFilterTransformer>
              <threadCount>1</threadCount>
              <threadAssignmentVariable></threadAssignmentVariable>
              <validateResponse>false</validateResponse>
              <resourceIds class="linked-hash-map">
                <entry>
                  <string>Default Resource</string>
                  <string>[Default Resource]</string>
                </entry>
              </resourceIds>
              <queueBufferSize>1000</queueBufferSize>
            </destinationConnectorProperties>
            <scheme>FILE</scheme>
            <host>c:/mirthtest</host>
            <outputPattern>in-${UUID}.xml</outputPattern>
            <anonymous>true</anonymous>
            <username>anonymous</username>
            <password>anonymous</password>
            <timeout>10000</timeout>
            <secure>true</secure>
            <passive>true</passive>
            <validateConnection>true</validateConnection>
            <outputAppend>true</outputAppend>
            <errorOnExists>false</errorOnExists>
            <temporary>false</temporary>
            <binary>false</binary>
            <charsetEncoding>DEFAULT_ENCODING</charsetEncoding>
            <template>${RDA_XML}</template>
          </properties>
          <transformer version="3.4.1">
            <steps/>
            <inboundTemplate encoding="base64"></inboundTemplate>
            <outboundTemplate encoding="base64"></outboundTemplate>
            <inboundDataType>XML</inboundDataType>
            <outboundDataType>XML</outboundDataType>
            <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </inboundProperties>
            <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </outboundProperties>
          </transformer>
          <responseTransformer version="3.4.1">
            <steps/>
            <inboundDataType>XML</inboundDataType>
            <outboundDataType>XML</outboundDataType>
            <inboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </inboundProperties>
            <outboundProperties class="com.mirth.connect.plugins.datatypes.xml.XMLDataTypeProperties" version="3.4.1">
              <serializationProperties class="com.mirth.connect.plugins.datatypes.xml.XMLSerializationProperties" version="3.4.1">
                <stripNamespaces>true</stripNamespaces>
              </serializationProperties>
              <batchProperties class="com.mirth.connect.plugins.datatypes.xml.XMLBatchProperties" version="3.4.1">
                <splitType>Element_Name</splitType>
                <elementName></elementName>
                <level>1</level>
                <query></query>
                <batchScript></batchScript>
              </batchProperties>
            </outboundProperties>
          </responseTransformer>
          <filter version="3.4.1">
            <rules/>
          </filter>
          <transportName>File Writer</transportName>
          <mode>DESTINATION</mode>
          <enabled>true</enabled>
          <waitForPrevious>true</waitForPrevious>
        </connector>
      </destinationConnectors>
      <preprocessingScript>// Modify the message variable below to pre process data
return message;</preprocessingScript>
      <postprocessingScript>// This script executes once after a message has been processed
// Responses returned from here will be stored as &quot;Postprocessor&quot; in the response map
return;</postprocessingScript>
      <deployScript>// This script executes once when the channel is deployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</deployScript>
      <undeployScript>// This script executes once when the channel is undeployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</undeployScript>
      <properties version="3.4.1">
        <clearGlobalChannelMap>true</clearGlobalChannelMap>
        <messageStorageMode>DEVELOPMENT</messageStorageMode>
        <encryptData>false</encryptData>
        <removeContentOnCompletion>false</removeContentOnCompletion>
        <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
        <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
        <initialState>STARTED</initialState>
        <storeAttachments>false</storeAttachments>
        <tags class="linked-hash-set"/>
        <metaDataColumns>
          <metaDataColumn>
            <name>SOURCE</name>
            <type>STRING</type>
            <mappingName>mirth_source</mappingName>
          </metaDataColumn>
          <metaDataColumn>
            <name>TYPE</name>
            <type>STRING</type>
            <mappingName>mirth_type</mappingName>
          </metaDataColumn>
        </metaDataColumns>
        <attachmentProperties version="3.4.1">
          <type>None</type>
          <properties/>
        </attachmentProperties>
        <archiveEnabled>true</archiveEnabled>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
      </properties>
      <codeTemplateLibraries>
        <codeTemplateLibrary version="3.4.1">
          <id>a91916e1-43f8-42f5-bcd8-87b14d83562b</id>
          <name>RRLibrary_v3_0_1</name>
          <revision>22</revision>
          <lastModified>
            <time>1487330365794</time>
            <timezone>Europe/London</timezone>
          </lastModified>
          <description>Renal Registry Extract Library
v3_0_1 - 17-02-2017 - Use LocalPatientId instead of localpatientid
v3_0_0 - 23-01-2017 - Now fully supports RDA and naming conventions in templates
v7 - includes c: expansion
v6 - includes common fields in extract where present
v5 - includes date ranges
</description>
          <includeNewChannels>true</includeNewChannels>
          <enabledChannelIds>
            <string>0b98b374-e8e7-4be3-8b0c-1c85a0063464</string>
            <string>9b52ae3f-ddc0-46dc-b0e7-87b4b7383e4b</string>
            <string>da25e1e0-d6cc-4a73-9559-919846f5a942</string>
            <string>a4c6850d-ae1a-4af9-801f-5a9ecdbd374f</string>
            <string>6bfa2667-aa30-4c50-b994-550680dc0f78</string>
          </enabledChannelIds>
          <disabledChannelIds/>
          <codeTemplates>
            <codeTemplate version="3.4.1">
              <id>5489a394-d64d-4527-93e0-a4177713019e</id>
              <name>Add Channel Attributes</name>
              <revision>14</revision>
              <lastModified>
                <time>1482163011620</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Add the channel attributes to the message

	19/12/2016-12:28 - New Function

	@param {Any} tmp - The Mirth tmp message

*/
function addChannelAttributes(tmp){
	var currentDate = DateUtil.getCurrentDate(&apos;yyyyMMddHHmmss.SSS&apos;);
	var d = new Date();
	var endDate = globalMap.get(&quot;ExtractEndDate&quot;);
	var startDate = globalMap.get(&quot;ExtractStartDate&quot;);
     tmp.(@channelName=channelName);
     tmp.(@channelId=channelId);
     tmp.(@time=currentDate);
     tmp.(@startDate=startDate);
     tmp.(@endDate=endDate);
}</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>837910c1-b2c5-4a78-b398-72f7b438a96b</id>
              <name>Add Nodes based on table name and field array</name>
              <revision>59</revision>
              <lastModified>
                <time>1487330305076</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Add a database read for the tables, fields defined.
	Add the data returned into the node provided.
	18/01/2017-18:05 - Change the canonical form of coded fields
	11/01/2017-11:21 - Add Standard and Common Fields
     06/01/2017-12:02 - Use prepared statement
     06/01/2017-11:01 - Correct setting of node
	19/12/2016-11:48 - added tolerance for missing fields, returning &quot;N/D&quot; (Not Defined) instead of failing
				  - fixed ChannelName in error message
	25/11/2016-14:57 - remove quote from localpatientid
	22/11/2016-10:24 - add connection resilience
	21/11/2016-16:59 - xml escape the output
	15/11/2016-13:21 - get connection from globalChannelMap

	@param {Any} tmp - The Mirth tmp message
	@param {Any} pid - the patient id
	@param {Any} xmlName - name for canonical XML
	@param {Any} viewName - view name to read
	@param {Any} fields - list of field names to add to the XML
*/
function addNodes(tmp, pid, xmlName, viewName, fields){
	var dbConn;
	var result;
	var fname;
     var query = &quot;select * from &quot; +viewName + &quot; WHERE LocalPatientId = ? &quot;;
	var params = new java.util.ArrayList();
	params.add(pid);
	var sFields = [&quot;UpdatedOn&quot;, &quot;ActionCode&quot;, &quot;ExternalId&quot;];
	var cFields = [&quot;c:EnteredAt&quot;, &quot;c:EnteredBy&quot;, &quot;EnteredOn&quot;, &quot;FromTime&quot;, &quot;ToTime&quot;];

	try {
		dbConn = getCachedConnection();
		result = dbConn.executeCachedQuery(query, params);
 		while(result.next()){
 		   var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
		   for (index = 0; index &lt; fields.length; index++) {
		      var fName = fields[index];

		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, viewName+&quot;:Missing Requested Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, viewName+&quot;:Missing Requested Field&quot;);
			     node.appendChild(cfNode);
		      }
		   }
		   // Add standard fields
		   for (index = 0; index &lt; sFields.length; index++) {
		      var fName = sFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, viewName+&quot;:Missing Standard Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, viewName+&quot;:Missing Standard Field&quot;);
			     node.appendChild(cfNode);
		      }
			
		   }

		   // Add common fields
		   for (index = 0; index &lt; cFields.length; index++) {
		      var fName = cFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;&quot;, &quot;&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;&quot;, &quot;&quot;);
			     node.appendChild(cfNode);
		      }

		   }
		   tmp.appendChild(node);
		}
	} catch(e) {
		logger.error(e);
          // 2_0_4 add fault tolerance for missing views ( allows better vsn coexistance )
		var errMsg = e.javaException.getMessage();
    		logger.warn(errMsg);
 		if (errMsg.lastIndexOf(viewName,0)){
			logger.warn(channelName + &quot;: &quot; + viewName + &quot; does not exist&quot;);
			var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
			node.(@viewStatus=&quot;N/D&quot;);
	    		tmp.appendChild(node);
		} else {
			// log the error then throw to ensure that the message is flagged in error
			logger.error(query);
			logger.error(channelName + &quot; Message errored because:&quot; + e);
			throw(e);
		}

	} finally {
		//Leave the connection open
		//if (dbConn) {
		//	dbConn.close();
		//}
	}
}
</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>ecd7c75a-bc77-4471-95f0-819a04e4481c</id>
              <name>Add Nodes based on table name, field array and a date range</name>
              <revision>18</revision>
              <lastModified>
                <time>1487330308982</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Add a database read for the tables, fields defined limited by a date range
	Add the data returned into the node provided.

	12/01/2017-12:02 - Added std and common fields
     06/01/2017-11:42 - New template

	@param {Any} tmp - The Mirth tmp message
	@param {Any} pid - the patient id
	@param {Any} xmlName - name for canonical XML
	@param {Any} viewName - view name to read
	@param {Any} dateField - name of the date field used for extract selection
	@param {Any} fields - list of field names to add to the XML
*/
function addNodesByDate(tmp, pid, xmlName, viewName, dateField, fields){
	var dbConn;
	var result;
	var fname;
	var startDate = globalMap.get(&quot;ExtractStartDate&quot;); 
	var endDate = globalMap.get(&quot;ExtractEndDate&quot;); 
	var query = &quot;select * from &quot; + viewName + &quot; WHERE LocalPatientId = ? &quot; +
			  &quot; and &quot; + dateField + &quot; BETWEEN &apos;&quot; + startDate + &quot;&apos; and &apos;&quot; + endDate + &quot;&apos;&quot; ;

	var params = new java.util.ArrayList();
	params.add(pid);
	var sFields = [&quot;UpdatedOn&quot;, &quot;ActionCode&quot;, &quot;ExternalId&quot;];
	var cFields = [&quot;c:EnteredAt&quot;, &quot;c:EnteredBy&quot;, &quot;EnteredOn&quot;, &quot;FromTime&quot;, &quot;ToTime&quot;];

	try {
		dbConn = getCachedConnection();
		result = dbConn.executeCachedQuery(query, params);
 		while(result.next()){
 		   var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
		   for (index = 0; index &lt; fields.length; index++) {
		      var fName = fields[index];

		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, &quot;Missing Requested Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, &quot;Missing Requested Field&quot;);
			     node.appendChild(cfNode);
		      }
		   }
		   // Add standard fields
		   for (index = 0; index &lt; sFields.length; index++) {
		      var fName = sFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;W&quot;, &quot;Missing Standard Field&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;W&quot;, &quot;Missing Standard Field&quot;);
			     node.appendChild(cfNode);
		      }
			
		   }

		   // Add common fields
		   for (index = 0; index &lt; cFields.length; index++) {
		      var fName = cFields[index];
		      var fValue = null;
		      if (fName.indexOf(&quot;c:&quot;) == -1) {
		      	fValue = getField(result, fName, &quot;&quot;, &quot;&quot;);
			  	 if (fValue !== null) {
					 var fValueE = XmlUtil.encode(fValue);
				      node.appendChild(new XML(&apos;&lt;&apos;+fName+&apos;&gt;&apos;+fValueE.trim()+&apos;&lt;/&apos;+fName+&apos;&gt;&apos;));
			  	 }
		      } else {
				var cfNode = getCodedFieldNode(result, fName, &quot;&quot;, &quot;&quot;);
			     node.appendChild(cfNode);
		      }

		   }

		   tmp.appendChild(node);
		}
	} catch(e) {
          // 2_0_4 add fault tolerance for missing views ( allows better vsn coexistance )
		var errMsg = e.javaException.getMessage();
    		logger.warn(errMsg);
 		if (errMsg.lastIndexOf(viewName,0)){
			logger.warn(channelName + &quot;: &quot; + viewName + &quot; does not exist&quot;);
			var node = new XML(&apos;&lt;&apos; + xmlName + &apos;&gt;&lt;/&apos; + xmlName + &apos;&gt;&apos;);
			node.(@viewStatus=&quot;N/D&quot;);
	    tmp.appendChild(node);
		} else {
			// log the error then throw to ensure that the message is flagged in error
			logger.error(query);
			logger.error(channelName + &quot; Message errored because:&quot; + e);
			throw(e);
		}

	} finally {
		//Leave the connection open
		//if (dbConn) {
		//	dbConn.close();
		//}
	}
}
</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>8888f3db-ec2a-4205-82ab-55f3108c5001</id>
              <name>Get Field</name>
              <revision>5</revision>
              <lastModified>
                <time>1484815904972</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Gets the field from the cursor, implementing appropriate error behaviour

	@param result - current cursor row
	@param fName - field name to get
	@param eLevel - what to do if it all goes wrong
	@param logMsg - what to say
	@return {String} return field value
*/
function getField(result, fName, eLevel, logMsg) {
	 var fValue = null;
      try {
	      fValue = result.getString(fName);
      } catch(fe) {
      	if (eLevel==&quot;W&quot;){
			logger.warn(channelName + logMsg + fName);
			fValue = &quot;N/D&quot;;
      	}
      }
	return fValue;
}</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>dd6b4b84-8dd9-4269-aac4-b0c3667b7e14</id>
              <name>Get the database connection</name>
              <revision>5</revision>
              <lastModified>
                <time>1479812880608</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Get a database connection. 
	Retrieve the connection from the globalMap. If that is not null and not closed then return it
	If it is not viable then get another connection.

	@return {String} return description
*/
function getCachedConnection() {
	var dbConn;
	try {
		dbConn = globalMap.get(&apos;ukrdcDbConn&apos;);
		if (dbConn == null){
			dbConn = DatabaseConnectionFactory.createDatabaseConnection(configurationMap.get(&quot;dbDriver&quot;),
												     configurationMap.get(&quot;dbUrl&quot;),
												     configurationMap.get(&quot;dbUser&quot;),
												     configurationMap.get(&quot;dbPassword&quot;));
			logger.info(&quot;Connection was null. Recreated:&quot;+dbConn);
			globalMap.put(&apos;ukrdcDbConn&apos;, dbConn);
		}
		if (dbConn.getConnection().isClosed()){
			dbConn = DatabaseConnectionFactory.createDatabaseConnection(configurationMap.get(&quot;dbDriver&quot;),
												     configurationMap.get(&quot;dbUrl&quot;),
												     configurationMap.get(&quot;dbUser&quot;),
												     configurationMap.get(&quot;dbPassword&quot;));
			logger.info(&quot;Connection was closed. Recreated:&quot;+dbConn);
			globalMap.put(&apos;ukrdcDbConn&apos;, dbConn);
		}
	} catch(e) {
		// log the error then throw to ensure that the message is flagged in error
		logger.error($(&apos;ChannelName&apos;) + &quot;Error:&quot;);
		logger.error(e);
		throw(e);
		
	} finally {
		//Leave the connection open
		//if (dbConn) {
		//	dbConn.close();
		//}
	}
	return dbConn;
}
</code>
            </codeTemplate>
            <codeTemplate version="3.4.1">
              <id>fff3061e-b29a-4b8c-ac46-0d24c9e39349</id>
              <name>GetCodedFieldName</name>
              <revision>10</revision>
              <lastModified>
                <time>1485181740048</time>
                <timezone>Europe/London</timezone>
              </lastModified>
              <type>FUNCTION</type>
              <contextSet>
                <delegate>
                  <contextType>DESTINATION_DISPATCHER</contextType>
                  <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                  <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                  <contextType>SOURCE_RECEIVER</contextType>
                </delegate>
              </contextSet>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} fname - field name
	@return {Node} return coded field node
*/
function getCodedFieldNode(result, fName, eLevel, eMessage) {
	var base = fName.substring(2);
 	var codedNode = new XML(&quot;&lt;&quot;+base+&quot;&gt;&lt;/&quot;+base+&quot;&gt;&quot;);
 	fValue = getField(result, base+&quot;Code&quot;, eLevel, eMessage);
 	if (fValue !== null) {
	   var fValueE = XmlUtil.encode(fValue);
        codedNode.appendChild(new XML(&quot;&lt;Code&gt;&quot;+fValueE.trim()+&quot;&lt;/Code&gt;&quot;));
 	}
 	fValue = getField(result, base+&quot;CodeStd&quot;, eLevel, eMessage);
 	if (fValue !== null) {
	   var fValueE = XmlUtil.encode(fValue);
        codedNode.appendChild(new XML(&quot;&lt;CodeStd&gt;&quot;+fValueE.trim()+&quot;&lt;/CodeStd&gt;&quot;));
 	}
 	fValue = getField(result, base+&quot;Desc&quot;, eLevel, eMessage);
 	if (fValue !== null) {
	   var fValueE = XmlUtil.encode(fValue);
        codedNode.appendChild(new XML(&quot;&lt;Desc&gt;&quot;+fValueE.trim()+&quot;&lt;/Desc&gt;&quot;));
 	}
 	return codedNode;
}</code>
            </codeTemplate>
          </codeTemplates>
        </codeTemplateLibrary>
      </codeTemplateLibraries>
    </channel>
  </channels>
</channelGroup>